<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ECLIPTICA</title>

  <!-- Polices -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#00eaff;
      --accent:#8a2be2;
      --text:#e6f7ff;
      --muted:#9fb3c8;
      --bg-a:#05060d;
      --bg-b:#0b1430;
      --bg-c:#00182a;
      --ring: drop-shadow(0 0 8px rgba(0,234,255,.55)) drop-shadow(0 0 18px rgba(138,43,226,.35));
      --month: 8.333333%;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Outfit", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(0,234,255,.08), transparent 60%),
                  radial-gradient(900px 700px at -10% 30%, rgba(138,43,226,.08), transparent 50%),
                  linear-gradient(180deg, var(--bg-a), var(--bg-b) 40%, var(--bg-c));
      background-attachment: fixed;
      overflow-x:hidden;
    }

    .stars, .stars::before, .stars::after{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image: radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.7) 40%, transparent 42%),
                        radial-gradient(1px 1px at 60% 70%, rgba(255,255,255,.5) 40%, transparent 42%),
                        radial-gradient(1.5px 1.5px at 80% 20%, rgba(255,255,255,.5) 40%, transparent 42%),
                        radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.5) 40%, transparent 42%);
      opacity:.3; filter:blur(.2px);
    }
    .stars::before{content:""; animation: twinkle 8s linear infinite; opacity:.25}
    .stars::after {content:""; animation: twinkle 13s linear infinite reverse; opacity:.25}
    @keyframes twinkle{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}

    header.hero{ position:relative; z-index:1; padding:48px 20px 24px; text-align:center; }
    .brand{font-family:"Orbitron", sans-serif; letter-spacing:.06em; font-weight:800; font-size:14px; color:var(--muted); text-transform:uppercase}
    h1{ margin:.25rem auto .5rem; max-width:900px; font-family:"Orbitron", sans-serif; font-size:clamp(28px, 4.6vw, 54px); font-weight:900; line-height:1.02; text-shadow:0 0 6px rgba(0,234,255,.35), 0 0 18px rgba(138,43,226,.25); }
    h1 .grad{background:linear-gradient(92deg, var(--primary), var(--accent)); -webkit-background-clip:text; background-clip:text; color:transparent;}
    .lead{max-width:840px; margin:0 auto; color:var(--muted)}

    .controls{
      position:sticky; top:0; z-index:3;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;
      padding:12px 16px; margin:20px auto 0; backdrop-filter:blur(8px);
      background:linear-gradient(180deg, rgba(5,6,13,.72), rgba(5,6,13,.35));
      border:1px solid rgba(255,255,255,.06); border-radius:16px; width:min(1100px, 92%);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    /* Chips dynamiques = cercles principaux de SPHAIRA */
    .chips{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chip{
      --dot:#00eaff;
      display:inline-flex; align-items:center; gap:.6ch; cursor:pointer; user-select:none;
      padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      color:var(--text); font-size:14px; transition:.2s ease; filter:var(--ring);
    }
    .chip[data-active="true"]{ border-color:rgba(0,234,255,.55); box-shadow:0 0 0 2px rgba(0,234,255,.12) inset }
    .chip .dot{width:10px; height:10px; border-radius:50%; box-shadow:0 0 10px var(--dot); background:var(--dot)}
    .chip .label{white-space:nowrap}

    .spacer{flex:1 1 12px}

    .action-btn{
      display:inline-flex; align-items:center; gap:10px; cursor:pointer; font-weight:600;
      padding:10px 18px; border-radius:12px; border:1px solid rgba(0,234,255,.45);
      background:linear-gradient(180deg, rgba(0,234,255,.18), rgba(0,234,255,.05)); color:var(--text);
      text-transform:uppercase; letter-spacing:.05em; font-size:12px; filter:var(--ring);
      transition:transform .2s ease, border-color .2s ease;
    }
    .action-btn:hover{transform:translateY(-1px); border-color:rgba(138,43,226,.55)}
    .action-btn .ic{font-size:16px}

    .sync-status{
      margin:18px auto 0; width:min(620px, 92%);
      padding:12px 18px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(0,8,18,.88), rgba(0,8,18,.52));
      color:var(--muted); font-size:13px; display:flex; align-items:center; gap:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.3); backdrop-filter:blur(8px);
    }
    .sync-status .pulse{width:10px; height:10px; border-radius:50%; background:var(--primary); box-shadow:0 0 18px rgba(0,234,255,.6);
      animation:sync 2.4s ease-in-out infinite;}
    @keyframes sync{0%,100%{opacity:.45; transform:scale(.9);}50%{opacity:1; transform:scale(1.2);}}
    .months{display:flex; gap:6px; flex-wrap:wrap}
    .months button{all:unset; cursor:pointer; padding:8px 10px; font-size:12px; color:var(--muted); border-radius:10px; border:1px solid rgba(255,255,255,.08)}
    .months button:hover{color:var(--text); border-color:rgba(255,255,255,.16)}

    .meter{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .bar{position:relative; width:160px; height:7px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden}
    .bar>i{position:absolute; inset:0; width:var(--p,0%); background:linear-gradient(90deg, var(--primary), var(--accent)); box-shadow:0 0 18px rgba(0,234,255,.35)}

    .view{display:flex; gap:10px; border-left:1px solid rgba(255,255,255,.08); padding-left:10px}

    .wrap{position:relative; z-index:1; width:min(1200px, 92%); margin:28px auto 80px}

    /* Vues */
    body.view-vertical #timelineVertical{display:block}
    body.view-vertical #roadmapHoriz{display:none}
    body.view-roadmap #timelineVertical{display:none}
    body.view-roadmap #roadmapHoriz{display:block}

    .timeline{ position:relative; padding:40px 0; margin:0 auto; }
    .timeline::before{ content:""; position:absolute; left:50%; top:0; bottom:0; width:4px; transform:translateX(-50%);
      background:linear-gradient(180deg, rgba(0,234,255,.0), rgba(0,234,255,.7) 15%, rgba(138,43,226,.7) 85%, rgba(138,43,226,.0));
      filter:drop-shadow(0 0 10px rgba(0,234,255,.35)); }

    .month{ position:relative; margin:36px 0 16px; scroll-margin-top:90px; }
    .month h2{ display:inline-flex; align-items:center; gap:10px; font-family:"Orbitron", sans-serif; font-weight:800;
      font-size:18px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);
      background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:6px 12px; }
    .month.is-today h2{color:var(--text); border-color:rgba(0,234,255,.35); box-shadow:0 0 0 2px rgba(0,234,255,.15) inset}

    .item{position:relative; display:grid; grid-template-columns: 1fr 1fr; gap:28px; margin:18px 0}
    .item:nth-child(odd) .card{grid-column:1}
    .item:nth-child(odd) .node{left:calc(50% - 10px)}
    .item:nth-child(even) .card{grid-column:2}
    .item:nth-child(even) .node{left:calc(50% - 10px)}

    .node{position:absolute; top:18px; width:20px; height:20px; border-radius:50%; background:var(--bg-c);
      border:2px solid var(--primary); box-shadow:0 0 18px rgba(0,234,255,.55), inset 0 0 18px rgba(0,234,255,.25); filter:var(--ring)}

    .card{ position:relative; padding:16px 18px 16px 16px; border-radius:16px; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08);
      box-shadow:0 10px 30px rgba(0,0,0,.25); transition:transform .2s ease, border-color .2s ease; }
    .card::before{content:""; position:absolute; inset:-1px; border-radius:16px; padding:1px;
      background:linear-gradient(140deg, rgba(0,234,255,.5), rgba(138,43,226,.35)); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; opacity:.25}
    .card:hover{transform:translateY(-2px); border-color:rgba(0,234,255,.2)}

    .card .top{display:flex; align-items:center; gap:12px; margin-bottom:8px}
    .icon{width:28px; height:28px; border-radius:8px; display:grid; place-items:center; font-size:16px; filter:var(--ring);
      background:linear-gradient(120deg, rgba(0,234,255,.14), rgba(138,43,226,.14)); border:1px solid rgba(255,255,255,.12)}
    .title{font-weight:700; color:var(--text)}
    .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:12px}

    .badge{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--text)}
    .badge .dot{display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; box-shadow:0 0 10px currentColor}

    .desc{margin-top:8px; color:var(--text); opacity:.85; line-height:1.5}
    .card .tasks{list-style:none; margin:16px 0 0; padding:0; display:flex; flex-direction:column; gap:8px;}
    .card .task{display:flex; align-items:flex-start; gap:12px; font-size:13px; color:var(--text); background:rgba(255,255,255,.02); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,.04); position:relative; overflow:hidden;}
    .card .task::after{content:"Synchronis√© SPHAIRA"; position:absolute; right:12px; bottom:8px; font-size:10px; letter-spacing:.08em; text-transform:uppercase; color:rgba(230,247,255,.55); opacity:0; transition:.2s ease;}
    .card .task:hover::after{opacity:1;}
    .card .task .check{width:18px; height:18px; border-radius:50%; border:1px solid rgba(255,255,255,.16); display:grid; place-items:center; font-size:12px; line-height:1; background:rgba(0,8,18,.6); color:var(--text); margin-top:2px;}
    .card .task.is-done{background:rgba(0,234,255,.08); border-color:rgba(0,234,255,.25);}
    .card .task.is-done .check{border-color:rgba(0,234,255,.5); background:rgba(0,234,255,.25); color:#001018; font-weight:700;}
    .card .task .task-title{font-weight:600; display:block;}
    .card .task .task-title small{font-size:11px; font-weight:500; color:var(--muted); margin-left:6px; text-transform:uppercase; letter-spacing:.05em;}
    .card .task.is-done .task-title{text-decoration:line-through; color:var(--muted);}
    .card .task .task-meta{display:flex; flex-wrap:wrap; gap:6px; color:var(--muted); font-size:11px; margin-top:4px; text-transform:uppercase; letter-spacing:.06em;}
    .card .tasks.empty{margin:16px 0 0; padding:12px; border-radius:10px; border:1px dashed rgba(255,255,255,.12); color:var(--muted); text-align:center; font-size:12px; background:rgba(255,255,255,.02);}

    .ribbon{position:absolute; top:8px; right:-36px; transform:rotate(35deg); background:linear-gradient(90deg, var(--primary), var(--accent)); color:#001018;
      padding:4px 48px; font-size:12px; font-weight:800; letter-spacing:.08em; text-transform:uppercase; box-shadow:0 0 18px rgba(0,234,255,.45)}

    @media (max-width:900px){
      .item{grid-template-columns:1fr;}
      .timeline::before{left:24px; transform:none}
      .node{left:14px}
      .card{margin-left:52px}
      .task-row{grid-template-columns:1fr; gap:8px}
      .task-row .done{justify-content:flex-start}
    }

    /* Roadmap horizontale */
    .roadwrap{ width:min(1400px, 95%); margin:0 auto; }
    .roadscroll{ position:relative; overflow-x:auto; overflow-y:hidden; border:1px solid rgba(255,255,255,.08); border-radius:16px; backdrop-filter:blur(6px);
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,.08) 0 1px, transparent 1px calc(var(--month)), transparent calc(var(--month)) calc(2*var(--month))),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .roadmap{ position:relative; min-width:1200px; height:auto; padding-top:48px; }

    .axis{ position:sticky; top:0; z-index:2; height:36px; display:flex; align-items:center; gap:0; background:linear-gradient(180deg, rgba(5,6,13,.75), rgba(5,6,13,.35));
      border-bottom:1px solid rgba(255,255,255,.08); }
    .axis .tick{ position:relative; width:calc(var(--month)); text-align:center; font-size:12px; color:var(--muted); padding:6px 0; }
    .axis .tick::after{ content:""; position:absolute; right:0; top:0; bottom:0; width:1px; background:rgba(255,255,255,.08) }

    .lanes{ position:relative; }
    .lane{ position:relative; height:74px; border-bottom:1px dashed rgba(255,255,255,.08); }
    .lane.is-dim{ opacity:.35; filter:saturate(.6) }
    .lane .label{ position:sticky; left:0; z-index:1; height:100%; display:flex; align-items:center; gap:10px; padding:0 12px; width:210px;
      background:linear-gradient(90deg, rgba(5,6,13,.85), rgba(5,6,13,.0)); border-right:1px solid rgba(255,255,255,.08);
      font-size:13px; color:var(--text); }
    .lane .label .dot{ width:10px; height:10px; border-radius:50%; box-shadow:0 0 10px currentColor }
    .lane .bars{ position:relative; height:100%; margin-left:210px; }
    .taskMarkers{ position:absolute; inset:0; pointer-events:none; z-index:2; }
    .taskMarker{ position:absolute; top:6px; width:14px; height:14px; border-radius:50%; border:1px solid rgba(255,255,255,.35); background:linear-gradient(130deg, rgba(0,234,255,.55), rgba(138,43,226,.45)); box-shadow:0 0 12px rgba(0,234,255,.45); pointer-events:auto; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease, opacity .2s ease; display:grid; place-items:center; color:#02121a; font-size:10px; font-weight:700; z-index:3; }
    .taskMarker::before{content:'‚Ä¢'; line-height:1;}
    .taskMarker.is-done{background:linear-gradient(130deg, rgba(143,255,210,.85), rgba(0,234,255,.7)); border-color:rgba(143,255,210,.8); color:#012018; box-shadow:0 0 12px rgba(143,255,210,.55);}
    .taskMarker:focus-visible{outline:2px solid rgba(255,255,255,.8); outline-offset:2px; transform:scale(1.15);}
    .taskMarker:hover{transform:scale(1.1); box-shadow:0 0 16px rgba(0,234,255,.65);}
    .barItem{ position:absolute; top:16px; height:42px; min-width:32px; padding:8px 10px; border-radius:10px; display:flex; align-items:center; gap:8px;
      background:linear-gradient(120deg, rgba(0,234,255,.12), rgba(138,43,226,.12)); border:1px solid rgba(255,255,255,.18);
      box-shadow:0 8px 20px rgba(0,0,0,.25), 0 0 14px rgba(0,234,255,.15); backdrop-filter:blur(3px); white-space:nowrap; transform:translateZ(0);
      will-change:transform; }
    .barItem .ic{ font-size:14px }
    .barItem .t{ font-weight:700; font-size:13px }
    .barItem .d{ font-size:12px; color:var(--muted) }

    .todayLine{ position:absolute; top:36px; bottom:0; width:2px; background:linear-gradient(180deg, var(--primary), var(--accent)); box-shadow:0 0 14px rgba(0,234,255,.35); }

    .barItem[data-hint]:hover::after,
    .taskMarker[data-hint]:hover::after,
    .taskMarker[data-hint]:focus-visible::after{
      content:attr(data-hint); position:absolute; left:0; bottom:calc(100% + 8px); max-width:320px;
      background:rgba(0,8,14,.95); border:1px solid rgba(255,255,255,.15); padding:8px 10px; border-radius:8px; font-size:12px; color:var(--text);
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }

    .overlay{position:fixed; inset:0; background:rgba(1,4,12,.75); backdrop-filter:blur(6px); display:none; z-index:9;}
    .overlay[data-open="true"]{display:block}
    .panel{position:fixed; right:0; top:0; bottom:0; width:min(520px, 92%); background:rgba(4,10,24,.96); border-left:1px solid rgba(0,234,255,.25);
      box-shadow:-20px 0 40px rgba(0,0,0,.45); transform:translateX(100%); transition:transform .3s ease; z-index:10; display:flex; flex-direction:column;}
    .panel[data-open="true"]{transform:translateX(0)}
    .panel header{display:flex; align-items:center; justify-content:space-between; padding:24px 24px 12px; border-bottom:1px solid rgba(255,255,255,.08);}
    .panel header h2{font-family:"Orbitron", sans-serif; font-size:18px; margin:0; letter-spacing:.08em; text-transform:uppercase; color:var(--text);}
    .panel header .close{all:unset; cursor:pointer; color:var(--muted); font-size:20px; padding:4px; border-radius:6px; transition:.2s ease;}
    .panel header .close:hover{color:var(--text); background:rgba(255,255,255,.08)}
    .panel form{flex:1; overflow-y:auto; padding:16px 24px 32px; display:flex; flex-direction:column; gap:16px;}
    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);}
    .field input, .field textarea, .field select{
      padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(0,12,24,.6); color:var(--text);
      font-size:14px; font-family:inherit;
    }
    .field textarea{min-height:90px; resize:vertical}
    .tasks-block{border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:16px; background:rgba(0,12,24,.4); display:flex; flex-direction:column; gap:12px;}
    .tasks-block h3{margin:0; font-size:14px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);}
    .task-row{display:grid; grid-template-columns:1fr 120px 120px auto 32px; gap:10px; align-items:center; padding:10px; border-radius:10px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06);}
    .task-row input[type="text"]{width:100%;}
    .task-row input[type="date"]{width:100%; font-size:13px;}
    .task-row .done{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);}
    .task-row .remove{all:unset; cursor:pointer; color:#ff6b6b; font-size:16px; padding:4px; border-radius:6px;}
    .task-row .remove:hover{background:rgba(255,107,107,.18)}
    .task-row input[type="checkbox"]{accent-color:var(--primary);}
    .tasks-block .add-task{align-self:flex-start; padding:8px 12px; border-radius:999px; border:1px dashed rgba(0,234,255,.4); background:rgba(0,234,255,.08); color:var(--text); font-size:12px; cursor:pointer;}
    .tasks-block .add-task:hover{border-style:solid}
    .tasks-block .empty{margin:0; font-size:13px; color:var(--muted); padding:12px; border-radius:10px; border:1px dashed rgba(255,255,255,.12); background:rgba(255,255,255,.02);}
    .panel footer{padding:16px 24px 24px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:12px;}
    .panel footer button{flex:1; padding:12px 16px; border-radius:12px; border:1px solid rgba(0,234,255,.4); background:linear-gradient(120deg, rgba(0,234,255,.18), rgba(138,43,226,.12)); color:var(--text); font-weight:600; letter-spacing:.05em; cursor:pointer; text-transform:uppercase; font-size:12px;}
    .panel footer .secondary{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.12); color:var(--muted);}
    .panel footer button:hover{filter:brightness(1.1)}

    footer{color:var(--muted); text-align:center; margin:60px 0 50px}
    .warn{color:#ffd166}
  </style>
</head>
<body class="view-roadmap">
  <div class="stars"></div>

  <header class="hero">
    <div class="brand">ECLIPTICA // Hub de pilotage</div>
    <h1>Objectifs SPHAIRA <span class="grad">2025</span></h1>
    <p class="lead">Visualisez, orchestrez et synchronisez la feuille de route de <strong>SPHAIRA</strong> avec <strong>ORIS</strong>. Les vues <strong>Verticale</strong> et <strong>Roadmap</strong> refl√®tent en temps r√©el les √©volutions partag√©es entre les plateformes.</p>

    <div class="controls" role="region" aria-label="Filtres et navigation">
      <div id="chipsContainer" class="chips" aria-live="polite"></div>

      <span class="spacer"></span>

      <button class="action-btn" id="createObjective"><span class="ic">Ôºã</span> Nouvel objectif</button>

      <div class="months" aria-label="Aller au mois">
        <button data-go="01">Jan</button>
        <button data-go="02">F√©v</button>
        <button data-go="03">Mar</button>
        <button data-go="04">Avr</button>
        <button data-go="05">Mai</button>
        <button data-go="06">Juin</button>
        <button data-go="07">Juil</button>
        <button data-go="08">Ao√ªt</button>
        <button data-go="09">Sep</button>
        <button data-go="10">Oct</button>
        <button data-go="11">Nov</button>
        <button data-go="12">D√©c</button>
      </div>

      <div class="meter" title="Progression de l'ann√©e 2025">
        <span>Progression</span>
        <div class="bar"><i id="yearProgress"></i></div>
        <span id="yearPct">0%</span>
      </div>

      <div class="view" aria-label="Changer de vue">
        <button class="chip chip-view" data-view="vertical"><span class="dot"></span> <span class="label">Vue verticale</span></button>
        <button class="chip chip-view" data-view="roadmap" data-active="true"><span class="dot"></span> <span class="label">Vue roadmap</span></button>
      </div>
    </div>
    <div class="sync-status" id="syncStatus" role="status" aria-live="polite">
      <span class="pulse" aria-hidden="true"></span>
      <span>Synchronisation pr√™te avec SPHAIRA & ORIS.</span>
    </div>
  </header>

  <main class="wrap">
    <section id="timelineVertical" class="timeline" aria-label="Timeline 2025 (vertical)"></section>

    <section id="roadmapHoriz" class="roadwrap" aria-label="Timeline 2025 (roadmap)">
      <div class="roadscroll" id="roadscroll">
        <div class="axis" id="axis"></div>
        <div class="roadmap" id="roadmap">
          <div class="lanes" id="lanes"></div>
          <div class="todayLine" id="todayLine" hidden></div>
        </div>
      </div>
      <p id="noWorkspaceHint" class="warn" style="display:none;margin:10px 6px 0 6px">‚ö†Ô∏è Aucun espace SPHAIRA d√©tect√©. Ouvrez d'abord <strong>SPHAIRA</strong> puis revenez ici.</p>
    </section>
  </main>

  <div class="overlay" id="panelOverlay" aria-hidden="true"></div>
  <aside class="panel" id="detailPanel" data-open="false" aria-hidden="true">
    <header>
      <h2 id="panelHeading">Nouvel objectif</h2>
      <button type="button" class="close" id="closePanel" aria-label="Fermer la fen√™tre">√ó</button>
    </header>
    <form id="objectiveForm">
      <div class="field">
        <label for="objectiveNode">Cercle (SPHAIRA)</label>
        <select id="objectiveNode" required></select>
      </div>
      <div class="field">
        <label for="objectiveTitle">Titre de l'objectif</label>
        <input id="objectiveTitle" name="title" required placeholder="Ex : Stabiliser le noyau SPHAIRA">
      </div>
      <div class="field">
        <label for="objectiveDate">√âch√©ance</label>
        <input id="objectiveDate" name="date" type="date" required>
      </div>
      <div class="field">
        <label for="objectiveIcon">Ic√¥ne (cosm√©tique)</label>
        <input id="objectiveIcon" name="icon" maxlength="3" placeholder="üéØ">
      </div>
      <div class="field">
        <label for="objectiveDesc">Description</label>
        <textarea id="objectiveDesc" name="desc" placeholder="Synth√®se de l'impact et du livrable"></textarea>
      </div>
      <div class="tasks-block">
        <h3>T√¢ches li√©es</h3>
        <div id="tasksContainer" aria-live="polite"></div>
        <button type="button" class="add-task" id="addTaskBtn">Ôºã Ajouter une t√¢che</button>
      </div>
    </form>
    <footer>
      <button type="button" class="secondary" id="deleteObjective" hidden>Supprimer</button>
      <button type="submit" form="objectiveForm" id="saveObjective">Enregistrer & synchroniser</button>
    </footer>
  </aside>

  <footer>
    ECLIPTICA assure la coh√©rence des plans d'action : les mises √† jour sont √©crites dans <strong>SPHAIRA</strong> (localStorage) et visibles dans <strong>ORIS</strong>.
  </footer>

  <script>
  /* ====== Acc√®s workspace SPHAIRA (localStorage) ====== */
  const STORAGE_KEYS = ['sphaira:workspaceState:v2','sphaira:workspaceState:v1','workspaceState'];
  const FALLBACK_COLORS = ['#00eaff','#ff6ec7','#ffd166','#5bd3ff','#8a2be2','#8cffd2','#ffa3a3','#a3c4ff'];

  let sphairaWorkspace = { json:null, storageKey:null };

  function loadWorkspaceFromStorage(){
    for(const key of STORAGE_KEYS){
      try{ const raw = localStorage.getItem(key); if(raw){ sphairaWorkspace = { json: JSON.parse(raw), storageKey:key }; return sphairaWorkspace; } }catch(_){}
    }
    sphairaWorkspace = { json:null, storageKey:null }; return sphairaWorkspace;
  }
  function persistWorkspace(){
    if(!sphairaWorkspace.json) return false;
    const str = JSON.stringify(sphairaWorkspace.json);
    try{
      if(sphairaWorkspace.storageKey) localStorage.setItem(sphairaWorkspace.storageKey, str);
      try{ localStorage.setItem('workspaceState', str);}catch{}
      try{ localStorage.setItem('sphaira:workspaceState:v1', str);}catch{}
      try{ localStorage.setItem('sphaira:lastWriteAt', Date.now().toString()); }catch{}
      return true;
    }catch(e){ console.error('[ECLIPTICA] Persist √©chou√©e', e); return false; }
  }
  function getAllNodes(){ return Array.isArray(sphairaWorkspace.json?.nodes) ? sphairaWorkspace.json.nodes : []; }
  function getNodeById(id){ return getAllNodes().find(n=>n.id===id); }
  function ensureArraysOnNode(node){
    if(!node) return;
    if(!Array.isArray(node._tasks) && Array.isArray(node.tasks)) node._tasks = node.tasks;
    if(!Array.isArray(node._objectives) && Array.isArray(node.objectives)) node._objectives = node.objectives;
    if(!Array.isArray(node._tasks)) node._tasks = [];
    if(!Array.isArray(node._objectives)) node._objectives = [];
    node._tasks.forEach(t=>{ if(!Array.isArray(t.objectiveIds)) t.objectiveIds = []; t.start=t.start||''; t.end=t.end||''; t.done=!!t.done; });
    node._objectives.forEach(o=>{ if(!Array.isArray(o.taskIds)) o.taskIds = []; o.due=o.due||''; o.completed=!!o.completed; o.completedAt=o.completedAt||null; });
    node.tasks = node._tasks; node.objectives = node._objectives;
  }

  /* ====== R√©f√©rences qualifi√©es ====== */
  function qualifyTaskRef(nodeId, taskId){ return `${nodeId}::${taskId}`; }
  function qualifyObjectiveRef(nodeId, objId){ return `${nodeId}::${objId}`; }

  function resolveTaskRef(ref){
    if(!ref) return null;
    const hasQual = String(ref).includes('::'); let nodeId, taskId;
    if(hasQual){ [nodeId, taskId] = String(ref).split('::'); }
    const nodes = getAllNodes();
    if(nodeId){
      const node = getNodeById(nodeId); if(!node) return null;
      ensureArraysOnNode(node);
      const task = (node._tasks||[]).find(t=>t.id===taskId);
      return task ? { node, task } : null;
    }
    for(const node of nodes){ ensureArraysOnNode(node); const t=(node._tasks||[]).find(x=>x.id===ref); if(t) return { node, task:t }; }
    return null;
  }
  function resolveObjectiveRef(ref){
    if(!ref) return null;
    const hasQual = String(ref).includes('::'); let nodeId, objId;
    if(hasQual){ [nodeId, objId] = String(ref).split('::'); }
    const nodes = getAllNodes();
    if(nodeId){
      const node = getNodeById(nodeId); if(!node) return null;
      ensureArraysOnNode(node);
      const objective = (node._objectives||[]).find(o=>o.id===objId);
      return objective ? { node, objective } : null;
    }
    for(const node of nodes){ ensureArraysOnNode(node); const o=(node._objectives||[]).find(x=>x.id===ref); if(o) return { node, objective:o }; }
    return null;
  }

  /* ====== Graphe parent/enfants + cercles principaux ====== */
  let PARENT_OF = new Map(); // childId -> parentId
  function buildParentMap(){
    PARENT_OF = new Map();
    const nodes = getAllNodes();
    for(const n of nodes){
      if(n.parentId){ PARENT_OF.set(n.id, n.parentId); }
      const children = Array.isArray(n.children) ? n.children
                     : Array.isArray(n.childIds) ? n.childIds
                     : [];
      for(const c of children){
        if(typeof c==='string') PARENT_OF.set(c, n.id);
        else if(c && typeof c==='object' && c.id) PARENT_OF.set(c.id, n.id);
      }
    }
  }

  function isExplicitMain(n){
    // indicateurs possibles c√¥t√© SPHAIRA
    if(n.isMain === true || n.main === true || n.primary === true || n.isPrimary === true) return true;
    if(typeof n.type === 'string' && /main|primary/i.test(n.type)) return true;
    if(typeof n.kind === 'string' && /main|primary/i.test(n.kind)) return true;
    if(Array.isArray(n.tags) && n.tags.some(t=>/main|principal/i.test(String(t)))) return true;
    if(n.level === 0 || n.depth === 0 || n.root === true) return true;
    return false;
  }

  let MAINS = [];         // liste des cercles principaux (objets node)
  let MAINS_SET = new Set(); // ids principaux pour acc√®s rapide

  function computeMainCircles(){
    const nodes = getAllNodes();
    if(nodes.length===0){ MAINS=[]; MAINS_SET=new Set(); return; }
    buildParentMap();

    // 1) Si des cercles ont un marquage explicite "principal", on ne prend QUE ceux-l√†
    const explicit = nodes.filter(isExplicitMain);
    let mains = [];
    if(explicit.length>0){
      mains = explicit;
    } else {
      // 2) Sinon: principaux = sommets (sans parent)
      mains = nodes.filter(n => !PARENT_OF.has(n.id));
    }

    // tri: par champ order si disponible, sinon par nom
    mains.sort((a,b)=>{
      const ao = (a.order??a.index??a.position??9999), bo = (b.order??b.index??b.position??9999);
      if(ao!==bo) return ao-bo;
      const an = (a.text||a.label||a.id); const bn=(b.text||b.label||b.id);
      return String(an).localeCompare(String(bn),'fr');
    });

    // d√©dup
    const seen=new Set(); const out=[];
    for(const m of mains){ if(!seen.has(m.id)){ seen.add(m.id); out.push(m); } }

    MAINS = out;
    MAINS_SET = new Set(out.map(n=>n.id));
  }

  function nodeLabel(n){ return (n.text||n.label||'').trim() || n.id; }
  function nodeColor(n, idx){
    const c = (n.color||n.colour||n.col||'').trim?.() || '';
    if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)) return c;
    return FALLBACK_COLORS[idx % FALLBACK_COLORS.length];
  }

  function findTopMainId(nodeId){
    if(!nodeId) return null;
    let cur = nodeId; let guard=0;
    while(guard++ < 50){
      if(MAINS_SET.has(cur)) return cur;
      const p = PARENT_OF.get(cur);
      if(!p) return cur; // racine si aucun "main" explicite
      cur = p;
    }
    return nodeId;
  }

  /* ====== Union des t√¢ches li√©es √† un objectif (bidirectionnel) ====== */
  function tasksLinkedToObjectiveAcrossWorkspace(objectiveRef){
    const nodes = getAllNodes(); const results = [];
    for(const n of nodes){
      ensureArraysOnNode(n);
      for(const t of n._tasks){
        if((t.objectiveIds||[]).includes(objectiveRef)){
          results.push({ node:n, task:t });
        }
      }
    }
    return results;
  }

  /* ====== Projection SPHAIRA -> OBJECTIVES UI ====== */
  let OBJECTIVES = []; // {id, nodeId, mainId, mainName, mainColor, date, title, icon, desc, tasks:[...]}
  function normalizeObjectiveForUI(node, obj){
    ensureArraysOnNode(node);
    const objectiveRef = qualifyObjectiveRef(node.id, obj.id);

    // A) via objective.taskIds
    const viaObj = (obj.taskIds||[])
      .map(ref => resolveTaskRef(ref))
      .filter(Boolean);

    // B) via toutes les t√¢ches qui pointent sur l'objectif
    const viaTask = tasksLinkedToObjectiveAcrossWorkspace(objectiveRef);

    // Union par cl√© qualifi√©e
    const mergedMap = new Map();
    [...viaObj, ...viaTask].forEach(({node:tn, task})=>{
      const q = qualifyTaskRef(tn.id, task.id);
      if(!mergedMap.has(q)) mergedMap.set(q, { node:tn, task });
    });

    const tasks = Array.from(mergedMap.values()).map(({node:tn, task})=>({
      id: qualifyTaskRef(tn.id, task.id),
      title: task.title || '(Sans titre)',
      due: task.end || task.start || '',
      done: !!task.done
    }));

    const mainId  = findTopMainId(node.id);
    const main    = getNodeById(mainId) || node;
    const mainIdx = MAINS.findIndex(m=>m.id===main.id);

    return {
      id: objectiveRef,
      nodeId: node.id,
      mainId: main.id,
      mainName: nodeLabel(main),
      mainColor: nodeColor(main, Math.max(0, mainIdx)),
      date: obj.due || '2025-01-01',
      title: obj.title || 'Objectif sans titre',
      icon: 'üéØ',
      desc: obj.desc || '',
      tasks
    };
  }

  function buildObjectivesFromWorkspace(){
    const nodes = getAllNodes();
    const out = [];
    nodes.forEach(n=>{
      ensureArraysOnNode(n);
      (n._objectives||[]).forEach(o=> out.push(normalizeObjectiveForUI(n,o)));
    });
    out.sort((a,b)=> new Date(a.date) - new Date(b.date));
    return out;
  }

  /* ====== UI helpers ====== */
  function fmtDate(d, withYear=false){ const opts={day:'2-digit',month:'short'}; if(withYear) opts.year='numeric'; return new Intl.DateTimeFormat('fr-FR',opts).format(d).replace('.',''); }
  const start = new Date('2025-01-01T00:00:00'); const end = new Date('2025-12-31T23:59:59'); const isYear2025 = new Date().getFullYear()===2025;
  function pctOfYear(d){ return ((d - start) / (end - start)) * 100; }
  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
  function groupByMonth(items){
    const map = new Map(Array.from({length:12}, (_,i)=>[(i+1).toString().padStart(2,'0'),[]]));
    for(const obj of items){ const d=new Date(obj.date); const key=(d.getMonth()+1).toString().padStart(2,'0'); map.get(key)?.push({...obj, d}); }
    for(const [,arr] of map){ arr.sort((a,b)=>a.d-b.d); }
    return map;
  }
  function groupByMain(items){
    const map = new Map(MAINS.map(m=>[m.id, []]));
    for(const obj of items){
      const d = new Date(obj.date);
      if(!map.has(obj.mainId)) map.set(obj.mainId, []);
      map.get(obj.mainId).push({...obj, d});
    }
    for(const [,arr] of map){ arr.sort((a,b)=>a.d-b.d); }
    return map;
  }
  function computeTaskSummary(obj){
    const total = obj.tasks?.length ?? 0;
    const done = obj.tasks?.filter(t=>t.done).length ?? 0;
    return { total, done, pct: total?Math.round(done/total*100):0 };
  }
  function buildTaskList(tasks){
    if(!tasks || tasks.length===0){ const empty=document.createElement('div'); empty.className='tasks empty'; empty.textContent='Aucune t√¢che renseign√©e'; return empty; }
    const list=document.createElement('ul'); list.className='tasks'; list.setAttribute('role','list');
    tasks.forEach(task=>{
      const item=document.createElement('li'); item.className='task'+(task.done?' is-done':'');
      const check=document.createElement('span'); check.className='check'; check.textContent=task.done?'‚úì':''; check.setAttribute('aria-hidden','true'); item.appendChild(check);
      const details=document.createElement('div');
      const title=document.createElement('span'); title.className='task-title'; title.textContent=task.title;
      const rawDue=task.due?new Date(task.due):null; const ok=rawDue && !Number.isNaN(rawDue.valueOf());
      const badge=document.createElement('small'); badge.textContent=ok?fmtDate(rawDue,true):'Sans √©ch√©ance'; title.appendChild(badge); details.appendChild(title);
      const meta=document.createElement('span'); meta.className='task-meta'; meta.textContent = task.done?'‚úì Termin√©':'‚Ä¢ √Ä suivre'; details.appendChild(meta);
      item.appendChild(details); list.appendChild(item);
    });
    return list;
  }

  /* ====== RENDERERS ====== */
  function renderVertical(){
    const container = document.getElementById('timelineVertical');
    const byMonth = groupByMonth(OBJECTIVES);
    const today = new Date(); const todayKey = isYear2025 ? (today.getMonth()+1).toString().padStart(2,'0') : null;

    container.innerHTML = '';
    for(let i=1;i<=12;i++){
      const key = i.toString().padStart(2,'0');
      const section = document.createElement('section'); section.className = 'month' + (todayKey === key ? ' is-today' : ''); section.id = `m${key}`;
      const heading = document.createElement('h2'); heading.textContent = new Date(`2025-${key}-01`).toLocaleDateString('fr-FR', {month:'long'}); section.appendChild(heading);

      const monthObjectives = byMonth.get(key) ?? [];
      if(monthObjectives.length === 0){
        const empty = document.createElement('div');
        empty.className = 'item is-empty'; empty.dataset.placeholder = 'true';
        empty.innerHTML = `<span class="node" aria-hidden="true"></span><div class="card"><div class="meta">Aucun objectif planifi√©</div></div>`;
        section.appendChild(empty);
      } else {
        monthObjectives.forEach(obj=>{
          const summary = computeTaskSummary(obj);
          const progressText = summary.total ? `${summary.done}/${summary.total} t√¢ches` : 'Aucune t√¢che';
          const item = document.createElement('article'); item.className='item'; item.dataset.cat=obj.mainId; item.dataset.id=obj.id;
          const isTodayObjective = isYear2025 && obj.d.toDateString()===today.toDateString();
          item.innerHTML = `
            <span class="node" aria-hidden="true"></span>
            <div class="card" role="button" tabindex="0" aria-label="${obj.title}">
              ${isTodayObjective ? '<div class="ribbon">Aujourd\'hui</div>' : ''}
              <div class="top">
                <div class="icon">${obj.icon||'üóÇÔ∏è'}</div>
                <div>
                  <div class="title">${obj.title}</div>
                  <div class="meta">
                    <span>${fmtDate(obj.d)}</span>
                    <span class="badge" style="color:${obj.mainColor}"><span class="dot"></span>${obj.mainName}</span>
                    <span>${progressText}</span>
                  </div>
                </div>
              </div>
              <div class="meta"><span>Synchronis√© SPHAIRA ‚Ä¢ ORIS</span></div>
              <p class="desc">${obj.desc || ''}</p>
            </div>`;
          section.appendChild(item);
          const card=item.querySelector('.card'); card.appendChild(buildTaskList(obj.tasks));
          card.addEventListener('click', ()=>openPanel(obj.id));
          card.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); openPanel(obj.id); }});
        });
      }
      container.appendChild(section);
    }
  }

  function renderRoadmap(){
    const axis = document.getElementById('axis');
    const lanesWrap = document.getElementById('lanes');
    const todayLine = document.getElementById('todayLine');

    axis.innerHTML=''; for(let i=0;i<12;i++){ const t=document.createElement('div'); t.className='tick'; t.style.width='calc(var(--month))'; t.textContent=new Date(2025,i,1).toLocaleDateString('fr-FR',{month:'short'}).replace('.',''); axis.appendChild(t); }

    lanesWrap.innerHTML='';
    const byMain = groupByMain(OBJECTIVES);
    MAINS.forEach((root,idx)=>{
      const arr = byMain.get(root.id) || [];
      if(arr.length===0) return;
      const lane=document.createElement('div'); lane.className='lane'; lane.dataset.cat=root.id;
      const color=nodeColor(root,idx);
      const label=document.createElement('div'); label.className='label'; label.style.color=color; label.innerHTML=`<span class="dot"></span>${nodeLabel(root)}`;
      lane.appendChild(label);

      const bars=document.createElement('div'); bars.className='bars';
      const markers=document.createElement('div'); markers.className='taskMarkers'; bars.appendChild(markers);

      arr.forEach(obj=>{
        const left=pctOfYear(obj.d);
        const bar=document.createElement('div'); bar.className='barItem'; bar.dataset.cat=obj.mainId; bar.dataset.id=obj.id;
        bar.style.left=`calc(${left}% - 80px)`; bar.style.width='max(2%, 140px)';
        const summary=computeTaskSummary(obj); const progressText=summary.total?`${summary.done}/${summary.total} t√¢ches`:'Aucune t√¢che';
        bar.setAttribute('data-hint', `${fmtDate(obj.d,true)} ‚Äî ${progressText}`);
        bar.innerHTML=`<span class="ic">${obj.icon||'üóÇÔ∏è'}</span><span class="t">${obj.title}</span><span class="d">‚Ä¢ ${fmtDate(obj.d)}</span>`;
        bar.setAttribute('role','button'); bar.setAttribute('tabindex','0');
        bars.appendChild(bar);

        (obj.tasks||[]).forEach(task=>{
          const rawDue = task.due?new Date(task.due):null; const dueDate = rawDue && !Number.isNaN(rawDue.valueOf()) ? rawDue : obj.d;
          if(!dueDate || Number.isNaN(dueDate.valueOf())) return;
          const m=document.createElement('span'); m.className='taskMarker'+(task.done?' is-done':'');
          m.dataset.cat=obj.mainId; m.dataset.taskId=task.id||''; m.dataset.objectiveId=obj.id;
          m.style.left=`calc(${clamp(pctOfYear(dueDate),0,100)}% - 7px)`;
          m.setAttribute('data-hint', `${task.title} ‚Äî ${task.done?'Termin√©':'√Ä suivre'} ‚Ä¢ ${fmtDate(dueDate,true)}`);
          m.setAttribute('role','button'); m.setAttribute('tabindex','0');
          m.addEventListener('click', ()=>openPanel(obj.id));
          m.addEventListener('keydown', ev=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); openPanel(obj.id);} });
          markers.appendChild(m);
        });

        bar.addEventListener('click', ()=>openPanel(obj.id));
        bar.addEventListener('keydown', ev=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); openPanel(obj.id);} });
      });

      lane.appendChild(bars); lanesWrap.appendChild(lane);
    });

    if(isYear2025){ const position=pctOfYear(new Date()); todayLine.style.left=`calc(${position}% + 210px)`; todayLine.hidden=false; } else { todayLine.hidden=true; }
  }

  function refreshTimelines(){ renderVertical(); renderRoadmap(); applyFilter(currentFilter); }

  /* ====== Chips filtres (UNIQUEMENT cercles principaux) ====== */
  const chipsContainer = document.getElementById('chipsContainer');
  let currentFilter = 'tous';
  function renderCircleChips(){
    chipsContainer.innerHTML='';
    const makeChip = (id, label, color, active=false)=>{
      const b=document.createElement('button');
      b.className='chip'; b.dataset.active=active?'true':'false';
      if(id!=='tous'){ b.dataset.cat=id; b.style.setProperty('--dot', color||'#00eaff'); }
      b.innerHTML=`<span class="dot"></span> <span class="label">${label}</span>`;
      b.addEventListener('click', ()=>{
        chipsContainer.querySelectorAll('.chip').forEach(c=>c.dataset.active='false');
        b.dataset.active='true'; applyFilter(id);
      });
      return b;
    };
    chipsContainer.appendChild(makeChip('tous','Tous','#00eaff', true));
    MAINS.forEach((r,idx)=> chipsContainer.appendChild(makeChip(r.id, nodeLabel(r), nodeColor(r,idx), false)));
  }
  function applyFilter(cat){
    currentFilter = cat;
    // Vue verticale
    document.querySelectorAll('#timelineVertical .item').forEach(item=>{
      if(item.dataset.placeholder==='true'){ item.style.display = cat==='tous' ? '' : 'none'; return; }
      if(cat==='tous'){ item.style.display=''; } else { item.style.display = item.dataset.cat===cat ? '' : 'none'; }
    });
    document.querySelectorAll('#timelineVertical .month').forEach(section=>{
      const hasVisible = Array.from(section.querySelectorAll('.item')).some(it=>it.style.display!=='none');
      section.style.display = hasVisible ? '' : 'none';
    });
    // Roadmap
    document.querySelectorAll('#lanes .lane').forEach(lane=>{
      if(cat==='tous'){
        lane.style.display=''; lane.classList.remove('is-dim');
        lane.querySelectorAll('.barItem').forEach(b=>{ b.style.opacity=1; b.style.pointerEvents='auto';});
        lane.querySelectorAll('.taskMarker').forEach(m=>{ m.style.opacity=1; m.style.pointerEvents='auto'; m.setAttribute('tabindex','0');});
      } else {
        const match = lane.dataset.cat===cat; lane.style.display=''; lane.classList.toggle('is-dim', !match);
        lane.querySelectorAll('.barItem').forEach(b=>{ b.style.opacity=match?1:0.2; b.style.pointerEvents=match?'auto':'none';});
        lane.querySelectorAll('.taskMarker').forEach(m=>{ m.style.opacity=match?1:0.2; m.style.pointerEvents=match?'auto':'none'; m.setAttribute('tabindex', match?'0':'-1');});
      }
    });
  }

  /* ====== Navigation / vue ====== */
  function attachMonthNav(){ document.querySelectorAll('.months button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key=btn.dataset.go;
      if(document.body.classList.contains('view-vertical')){
        document.getElementById(`m${key}`)?.scrollIntoView({behavior:'smooth', block:'start'});
      } else {
        const scroll=document.getElementById('roadscroll');
        const ratio=(parseInt(key,10)-1)/12; const target=ratio*(scroll.scrollWidth - scroll.clientWidth);
        scroll.scrollTo({ left: Math.max(0,target), behavior:'smooth' });
      }
    });
  });}
  function setYearProgress(){ const now=new Date(); let pct=0; if(now<start)pct=0; else if(now>end)pct=100; else pct=((now-start)/(end-start))*100;
    document.getElementById('yearProgress').style.setProperty('--p', pct.toFixed(2)+'%'); document.getElementById('yearPct').textContent=Math.round(pct)+'%'; }
  function attachViewSwitch(){ const chips=document.querySelectorAll('.chip-view'); chips.forEach(chip=>{
    chip.addEventListener('click', ()=>{ chips.forEach(c=>c.dataset.active='false'); chip.dataset.active='true';
      const view=chip.dataset.view; document.body.classList.toggle('view-vertical', view==='vertical'); document.body.classList.toggle('view-roadmap', view==='roadmap'); });
  });}

  /* ====== Panel / CRUD ====== */
  const overlay = document.getElementById('panelOverlay');
  const panel = document.getElementById('detailPanel');
  const panelHeading = document.getElementById('panelHeading');
  const closePanelBtn = document.getElementById('closePanel');
  const objectiveForm = document.getElementById('objectiveForm');
  const tasksContainer = document.getElementById('tasksContainer');
  const addTaskBtn = document.getElementById('addTaskBtn');
  const deleteObjectiveBtn = document.getElementById('deleteObjective');
  const createObjectiveBtn = document.getElementById('createObjective');
  const syncStatus = document.getElementById('syncStatus');
  const syncStatusMessage = syncStatus.querySelector('span:last-child');
  const objectiveNodeSelect = document.getElementById('objectiveNode');

  function showEmptyTaskMessage(){ tasksContainer.innerHTML='<p class="empty">Aucune t√¢che d√©finie pour le moment.</p>'; }
  function buildTaskRow(task={}){
    const row=document.createElement('div'); row.className='task-row';
    const rowId=task.id || `t${Date.now()}${Math.random().toString(36).slice(2,5)}`; row.dataset.id=rowId;
    row.innerHTML=`
      <input type="text" class="task-title" placeholder="Titre de la t√¢che" value="${task.title??''}" required>
      <input type="text" class="task-owner" placeholder="Pilote (cosm√©tique)" value="${task.owner??''}">
      <input type="date" class="task-due" value="${task.due??''}">
      <label class="done"><input type="checkbox" class="task-done" ${task.done?'checked':''}> Termin√©</label>
      <button type="button" class="remove" title="Supprimer la t√¢che">√ó</button>`;
    row.querySelector('.remove').addEventListener('click', ()=>{ row.remove(); ensureTaskEmptyState(); });
    return row;
  }
  function ensureTaskEmptyState(){ if(!tasksContainer.querySelector('.task-row')) showEmptyTaskMessage(); }
  function renderTaskRows(tasks){ tasksContainer.innerHTML=''; if(!tasks || tasks.length===0){ showEmptyTaskMessage(); return; } tasks.forEach(t=>tasksContainer.appendChild(buildTaskRow(t))); }
  function addTaskRow(task={}){ if(tasksContainer.querySelector('.empty')) tasksContainer.innerHTML=''; tasksContainer.appendChild(buildTaskRow(task)); }

  function populateNodeSelector(){
    const ws = sphairaWorkspace.json;
    if(!ws){ objectiveNodeSelect.innerHTML='<option value="">‚Äî</option>'; return; }
    const nodes = getAllNodes();
    const items = nodes.map(n=>({ id:n.id, name: nodeLabel(n)}));
    objectiveNodeSelect.innerHTML = items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
  }

  let currentObjectiveId = null; // qualified

  function openPanel(id=null){
    currentObjectiveId = id;
    overlay.dataset.open='true'; overlay.setAttribute('aria-hidden','false');
    panel.dataset.open='true'; panel.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden'; objectiveForm.reset();

    if(id){
      const res = resolveObjectiveRef(id); if(!res){ showEmptyTaskMessage(); deleteObjectiveBtn.hidden=true; return; }
      const { node, objective } = res; ensureArraysOnNode(node);
      panelHeading.textContent = objective.title||'Objectif';
      objectiveNodeSelect.value = node.id;
      document.getElementById('objectiveTitle').value = objective.title||'';
      document.getElementById('objectiveDate').value = objective.due||'';
      document.getElementById('objectiveIcon').value = 'üéØ';
      document.getElementById('objectiveDesc').value = objective.desc||'';
      const uiObj = normalizeObjectiveForUI(node, objective);
      renderTaskRows(uiObj.tasks||[]);
      deleteObjectiveBtn.hidden = false;
    } else {
      panelHeading.textContent='Nouvel objectif';
      const today = new Date();
      const defaultDate = today.getFullYear()===2025 ? today.toISOString().slice(0,10) : '2025-01-01';
      document.getElementById('objectiveDate').value = defaultDate;
      document.getElementById('objectiveIcon').value = 'üéØ';
      renderTaskRows([]);
      deleteObjectiveBtn.hidden = true;
    }
  }
  function closePanel(){ panel.dataset.open='false'; panel.setAttribute('aria-hidden','true'); overlay.dataset.open='false'; overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; objectiveForm.reset(); showEmptyTaskMessage(); currentObjectiveId=null; }
  function syncWithSystems(action, title){ const ts=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}); syncStatusMessage.textContent = (action==='suppression' ? `Suppression synchronis√©e pour ¬´ ${title} ¬ª (${ts}).` : `${action==='cr√©ation'?'Cr√©ation':'Mise √† jour'} synchronis√©e pour ¬´ ${title} ¬ª ‚Äî SPHAIRA & ORIS align√©s (${ts}).`); }

  /* ====== LOAD / REFRESH ====== */
  async function loadAll(){
    const syncMsg = document.getElementById('syncStatus').querySelector('span:last-child');
    syncMsg.textContent='Chargement depuis SPHAIRA‚Ä¶';
    const ws = loadWorkspaceFromStorage();
    const hint = document.getElementById('noWorkspaceHint');
    hint.style.display = ws.json ? 'none' : '';
    computeMainCircles();
    OBJECTIVES = ws.json ? buildObjectivesFromWorkspace() : [];
    renderCircleChips();          // n‚Äôaffiche que MAINS
    populateNodeSelector();
    refreshTimelines();
    const ts=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    syncMsg.textContent = `Synchronis√© avec SPHAIRA ‚Äî ${ts}`;
  }

  /* ====== SAVE (create/update) ====== */
  objectiveForm.addEventListener('submit', (event)=>{
    event.preventDefault();
    if(!sphairaWorkspace.json){ alert('Workspace SPHAIRA introuvable. Ouvrez SPHAIRA d\'abord.'); return; }
    const nodeId = String(document.getElementById('objectiveNode').value||'');
    const node = getNodeById(nodeId); if(!node){ alert('S√©lectionnez un cercle SPHAIRA.'); return; }
    ensureArraysOnNode(node);

    const formData = new FormData(objectiveForm);
    const title = (formData.get('title')||'').toString().trim();
    const due   = (formData.get('date')||'').toString();
    const desc  = (formData.get('desc')||'').toString();

    const rows = Array.from(document.querySelectorAll('#tasksContainer .task-row'));
    const uiTasks = rows.map(row=>({
      id: row.dataset.id,
      title: row.querySelector('.task-title').value.trim(),
      due: row.querySelector('.task-due').value,
      done: row.querySelector('.task-done').checked
    })).filter(t=>t.title);

    let action='cr√©ation';

    if(currentObjectiveId){
      const res = resolveObjectiveRef(currentObjectiveId); if(!res){ alert('Objectif introuvable.'); return; }
      const { node:curNode, objective } = res; ensureArraysOnNode(curNode);

      // migration de cercle si n√©cessaire
      let targetNode = curNode;
      if(curNode.id !== node.id){
        curNode._objectives = curNode._objectives.filter(o=>o.id!==objective.id);
        targetNode = node; ensureArraysOnNode(targetNode);
        targetNode._objectives.push(objective);
      }
      objective.title = title; objective.due = due; objective.desc = desc;
      const objectiveRef = qualifyObjectiveRef(targetNode.id, objective.id);

      // Ensemble "avant" = toutes les t√¢ches li√©es (de n'importe quel cercle)
      const before = tasksLinkedToObjectiveAcrossWorkspace(objectiveRef).map(({node:n,task})=>qualifyTaskRef(n.id, task.id));
      const beforeSet = new Set(before);

      // pour chaque ligne UI : cr√©er/mettre √† jour + lier
      const nowSet = new Set();
      uiTasks.forEach(tu=>{
        let resTask = resolveTaskRef(tu.id);
        if(!resTask){
          // cr√©e dans le cercle de l'objectif
          const newId = 't'+Date.now()+Math.random().toString(36).slice(2,5);
          const task = { id:newId, title:tu.title, desc:'', start:'', end: tu.due||'', done: !!tu.done, objectiveIds:[] };
          targetNode._tasks.push(task); resTask = { node: targetNode, task };
        }else{
          // met √† jour la t√¢che o√π qu'elle soit
          resTask.task.title = tu.title; resTask.task.end = tu.due||''; resTask.task.done = !!tu.done;
        }
        // lier bidirectionnellement
        const oRef = objectiveRef; const tRef = qualifyTaskRef(resTask.node.id, resTask.task.id);
        if(!(resTask.task.objectiveIds||[]).includes(oRef)) resTask.task.objectiveIds.push(oRef);
        if(!(objective.taskIds||[]).includes(tRef)) objective.taskIds.push(tRef);
        nowSet.add(tRef);
      });

      // d√©lier ce qui a √©t√© supprim√© c√¥t√© UI
      for(const ref of beforeSet){
        if(!nowSet.has(ref)){
          const r = resolveTaskRef(ref);
          if(r){
            const oRef = objectiveRef;
            r.task.objectiveIds = (r.task.objectiveIds||[]).filter(x=>x!==oRef);
          }
          objective.taskIds = (objective.taskIds||[]).filter(x=>x!==ref);
        }
      }

      // statut compl√©tion
      const linkedNow = tasksLinkedToObjectiveAcrossWorkspace(objectiveRef).map(x=>x.task);
      const allDone = linkedNow.length>0 && linkedNow.every(t=>t.done===true);
      objective.completed = allDone; objective.completedAt = allDone ? new Date().toISOString().slice(0,10) : null;

      action='mise √† jour';
    } else {
      // CREATE
      const newObjId = 'o'+Date.now()+Math.random().toString(36).slice(2,5);
      const objective = { id:newObjId, title, desc, due, taskIds:[], completed:false, completedAt:null };
      node._objectives.push(objective);
      const objectiveRef = qualifyObjectiveRef(node.id, newObjId);

      uiTasks.forEach(tu=>{
        const newId = 't'+Date.now()+Math.random().toString(36).slice(2,5);
        const task = { id:newId, title:tu.title, desc:'', start:'', end: tu.due||'', done: !!tu.done, objectiveIds:[objectiveRef] };
        node._tasks.push(task);
        objective.taskIds.push(qualifyTaskRef(node.id, newId));
      });

      const linkedNow = tasksLinkedToObjectiveAcrossWorkspace(objectiveRef).map(x=>x.task);
      const allDone = linkedNow.length>0 && linkedNow.every(t=>t.done===true);
      objective.completed = allDone; objective.completedAt = allDone ? new Date().toISOString().slice(0,10) : null;

      currentObjectiveId = objectiveRef;
    }

    if(!persistWorkspace()){ alert('Impossible d\'enregistrer SPHAIRA.'); return; }
    syncWithSystems(action, title);
    closePanel();
    loadAll();
  });

  /* ====== DELETE objective ====== */
  document.getElementById('deleteObjective').addEventListener('click', ()=>{
    if(!currentObjectiveId) return;
    const res = resolveObjectiveRef(currentObjectiveId); if(!res) return;
    const { node, objective } = res; ensureArraysOnNode(node);
    if(!confirm(`Supprimer l'objectif ¬´ ${objective.title} ¬ª ?`)) return;

    const objectiveRef = qualifyObjectiveRef(node.id, objective.id);
    // d√©lier toutes les t√¢ches, o√π qu'elles soient
    tasksLinkedToObjectiveAcrossWorkspace(objectiveRef).forEach(({node:n, task})=>{
      task.objectiveIds = (task.objectiveIds||[]).filter(x=>x!==objectiveRef);
    });
    // retirer les refs de l‚Äôobjectif
    objective.taskIds = [];
    // supprimer l‚Äôobjectif
    node._objectives = node._objectives.filter(o=>o.id!==objective.id);

    if(!persistWorkspace()){ alert('Impossible d\'enregistrer SPHAIRA.'); return; }
    syncWithSystems('suppression', objective.title||'Objectif');
    closePanel();
    loadAll();
  });

  /* ====== Boutons & listeners ====== */
  document.getElementById('addTaskBtn').addEventListener('click', ()=>addTaskRow({}));
  document.getElementById('createObjective').addEventListener('click', ()=>openPanel());
  document.getElementById('closePanel').addEventListener('click', closePanel);
  document.getElementById('panelOverlay').addEventListener('click', closePanel);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && panel.dataset.open==='true') closePanel(); });

  // Storage sync (multi-onglets)
  window.addEventListener('storage', (event)=>{ if(STORAGE_KEYS.includes(event.key) || event.key==='sphaira:lastWriteAt'){ loadAll(); } });

  // D√©marrage
  function attachMonthNavInit(){ attachMonthNav(); }
  loadAll();
  attachMonthNavInit();
  attachViewSwitch();
  setYearProgress();
  setInterval(setYearProgress, 60*60*1000);
  </script>
</body>
</html>
