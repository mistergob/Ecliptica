<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ECLIPTICA ‚Äî Objectifs SPHAIRA</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      /* ATMOS design tokens */
      --primary:#00eaff;       /* cyan n√©on */
      --accent:#8a2be2;        /* violet n√©on */
      --text:#e6f7ff;          
      --muted:#9fb3c8;
      --bg-a:#05060d;
      --bg-b:#0b1430;
      --bg-c:#00182a;
      --ring: drop-shadow(0 0 8px rgba(0,234,255,.55)) drop-shadow(0 0 18px rgba(138,43,226,.35));
      --month: 8.333333%;
    }

    /* --- Page reset --- */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Outfit", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(0,234,255,.08), transparent 60%),
                  radial-gradient(900px 700px at -10% 30%, rgba(138,43,226,.08), transparent 50%),
                  linear-gradient(180deg, var(--bg-a), var(--bg-b) 40%, var(--bg-c));
      background-attachment: fixed;
      overflow-x:hidden;
    }

    /* --- Subtle starfield --- */
    .stars, .stars::before, .stars::after{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image: radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.7) 40%, transparent 42%),
                        radial-gradient(1px 1px at 60% 70%, rgba(255,255,255,.5) 40%, transparent 42%),
                        radial-gradient(1.5px 1.5px at 80% 20%, rgba(255,255,255,.5) 40%, transparent 42%),
                        radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.5) 40%, transparent 42%);
      opacity:.3; filter:blur(.2px);
    }
    .stars::before{content:""; animation: twinkle 8s linear infinite; opacity:.25}
    .stars::after {content:""; animation: twinkle 13s linear infinite reverse; opacity:.25}
    @keyframes twinkle{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}

    /* --- Header / hero --- */
    header.hero{ position:relative; z-index:1; padding:48px 20px 24px; text-align:center; }
    .brand{font-family:"Orbitron", sans-serif; letter-spacing:.06em; font-weight:800; font-size:14px; color:var(--muted); text-transform:uppercase}
    h1{ margin:.25rem auto .5rem; max-width:900px; font-family:"Orbitron", sans-serif; font-size:clamp(28px, 4.6vw, 54px); font-weight:900; line-height:1.02; text-shadow:0 0 6px rgba(0,234,255,.35), 0 0 18px rgba(138,43,226,.25); }
    h1 .grad{background:linear-gradient(92deg, var(--primary), var(--accent)); -webkit-background-clip:text; background-clip:text; color:transparent;}
    .lead{max-width:840px; margin:0 auto; color:var(--muted)}

    /* --- Controls --- */
    .controls{
      position:sticky; top:0; z-index:3;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;
      padding:12px 16px; margin:20px auto 0; backdrop-filter:blur(8px);
      background:linear-gradient(180deg, rgba(5,6,13,.72), rgba(5,6,13,.35));
      border:1px solid rgba(255,255,255,.06); border-radius:16px; width:min(1100px, 92%);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .chip{ --o:.35; display:inline-flex; align-items:center; gap:.5ch; cursor:pointer; user-select:none;
      padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      color:var(--text); font-size:14px; transition:.2s ease; filter:var(--ring);
    }
    .chip[data-active="true"]{ border-color:rgba(0,234,255,.55); box-shadow:0 0 0 2px rgba(0,234,255,.12) inset }
    .chip .dot{width:8px; height:8px; border-radius:50%; background:var(--primary); box-shadow:0 0 10px rgba(0,234,255,.7)}
    .chip[data-cat="developpement"] .dot{background:#00eaff}
    .chip[data-cat="experience"]    .dot{background:#ff6ec7}
    .chip[data-cat="alignement"]    .dot{background:#ffd166}
    .chip[data-cat="operations"]    .dot{background:#5bd3ff}
    .chip[data-cat="lancement"]     .dot{background:#8a2be2}

    .spacer{flex:1 1 12px}

    .action-btn{
      display:inline-flex; align-items:center; gap:10px; cursor:pointer; font-weight:600;
      padding:10px 18px; border-radius:12px; border:1px solid rgba(0,234,255,.45);
      background:linear-gradient(180deg, rgba(0,234,255,.18), rgba(0,234,255,.05)); color:var(--text);
      text-transform:uppercase; letter-spacing:.05em; font-size:12px; filter:var(--ring);
      transition:transform .2s ease, border-color .2s ease;
    }
    .action-btn:hover{transform:translateY(-1px); border-color:rgba(138,43,226,.55)}
    .action-btn .ic{font-size:16px}

    .sync-status{
      margin:18px auto 0; width:min(620px, 92%);
      padding:12px 18px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(0,8,18,.88), rgba(0,8,18,.52));
      color:var(--muted); font-size:13px; display:flex; align-items:center; gap:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.3); backdrop-filter:blur(8px);
    }
    .sync-status .pulse{width:10px; height:10px; border-radius:50%; background:var(--primary); box-shadow:0 0 18px rgba(0,234,255,.6);
      animation:sync 2.4s ease-in-out infinite;}
    @keyframes sync{0%,100%{opacity:.45; transform:scale(.9);}50%{opacity:1; transform:scale(1.2);}}
    .months{display:flex; gap:6px; flex-wrap:wrap}
    .months button{all:unset; cursor:pointer; padding:8px 10px; font-size:12px; color:var(--muted); border-radius:10px; border:1px solid rgba(255,255,255,.08)}
    .months button:hover{color:var(--text); border-color:rgba(255,255,255,.16)}

    .meter{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .bar{position:relative; width:160px; height:7px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden}
    .bar>i{position:absolute; inset:0; width:var(--p,0%); background:linear-gradient(90deg, var(--primary), var(--accent)); box-shadow:0 0 18px rgba(0,234,255,.35)}

    .view{display:flex; gap:10px; border-left:1px solid rgba(255,255,255,.08); padding-left:10px}

    /* --- Shell --- */
    .wrap{position:relative; z-index:1; width:min(1200px, 92%); margin:28px auto 80px}

    /* ---------- VUE 1 : Timeline verticale (existante) ---------- */
    body.view-vertical #timelineVertical{display:block}
    body.view-vertical #roadmapHoriz{display:none}
    body.view-roadmap #timelineVertical{display:none}
    body.view-roadmap #roadmapHoriz{display:block}

    .timeline{ position:relative; padding:40px 0; margin:0 auto; }
    .timeline::before{ content:""; position:absolute; left:50%; top:0; bottom:0; width:4px; transform:translateX(-50%);
      background:linear-gradient(180deg, rgba(0,234,255,.0), rgba(0,234,255,.7) 15%, rgba(138,43,226,.7) 85%, rgba(138,43,226,.0));
      filter:drop-shadow(0 0 10px rgba(0,234,255,.35)); }

    .month{ position:relative; margin:36px 0 16px; scroll-margin-top:90px; }
    .month h2{ display:inline-flex; align-items:center; gap:10px; font-family:"Orbitron", sans-serif; font-weight:800;
      font-size:18px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted);
      background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:6px 12px; }
    .month.is-today h2{color:var(--text); border-color:rgba(0,234,255,.35); box-shadow:0 0 0 2px rgba(0,234,255,.15) inset}

    .item{position:relative; display:grid; grid-template-columns: 1fr 1fr; gap:28px; margin:18px 0}
    .item:nth-child(odd) .card{grid-column:1}
    .item:nth-child(odd) .node{left:calc(50% - 10px)}
    .item:nth-child(even) .card{grid-column:2}
    .item:nth-child(even) .node{left:calc(50% - 10px)}

    .node{position:absolute; top:18px; width:20px; height:20px; border-radius:50%; background:var(--bg-c);
      border:2px solid var(--primary); box-shadow:0 0 18px rgba(0,234,255,.55), inset 0 0 18px rgba(0,234,255,.25); filter:var(--ring)}

    .card{ position:relative; padding:16px 18px 16px 16px; border-radius:16px; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08);
      box-shadow:0 10px 30px rgba(0,0,0,.25); transition:transform .2s ease, border-color .2s ease; }
    .card::before{content:""; position:absolute; inset:-1px; border-radius:16px; padding:1px;
      background:linear-gradient(140deg, rgba(0,234,255,.5), rgba(138,43,226,.35)); -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; opacity:.25}
    .card:hover{transform:translateY(-2px); border-color:rgba(0,234,255,.2)}

    .card .top{display:flex; align-items:center; gap:12px; margin-bottom:8px}
    .icon{width:28px; height:28px; border-radius:8px; display:grid; place-items:center; font-size:16px; filter:var(--ring);
      background:linear-gradient(120deg, rgba(0,234,255,.14), rgba(138,43,226,.14)); border:1px solid rgba(255,255,255,.12)}
    .title{font-weight:700; color:var(--text)}
    .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:12px}

    .badge{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--text)}
    .badge[data-cat="developpement"]{background:rgba(0,234,255,.12); border-color:rgba(0,234,255,.45)}
    .badge[data-cat="experience"]   {background:rgba(255,110,199,.12); border-color:rgba(255,110,199,.35)}
    .badge[data-cat="alignement"]   {background:rgba(255,209,102,.12); border-color:rgba(255,209,102,.35)}
    .badge[data-cat="operations"]   {background:rgba(91,211,255,.12); border-color:rgba(91,211,255,.35)}
    .badge[data-cat="lancement"]    {background:rgba(138,43,226,.12); border-color:rgba(138,43,226,.35)}

    .desc{margin-top:8px; color:var(--text); opacity:.85; line-height:1.5}
    .card .tasks{list-style:none; margin:16px 0 0; padding:0; display:flex; flex-direction:column; gap:8px;}
    .card .task{display:flex; align-items:flex-start; gap:12px; font-size:13px; color:var(--text); background:rgba(255,255,255,.02); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,.04); position:relative; overflow:hidden;}
    .card .task::after{content:"Synchronis√© SPHAIRA"; position:absolute; right:12px; bottom:8px; font-size:10px; letter-spacing:.08em; text-transform:uppercase; color:rgba(230,247,255,.55); opacity:0; transition:.2s ease;}
    .card .task:hover::after{opacity:1;}
    .card .task .check{width:18px; height:18px; border-radius:50%; border:1px solid rgba(255,255,255,.16); display:grid; place-items:center; font-size:12px; line-height:1; background:rgba(0,8,18,.6); color:var(--text); margin-top:2px;}
    .card .task.is-done{background:rgba(0,234,255,.08); border-color:rgba(0,234,255,.25);}
    .card .task.is-done .check{border-color:rgba(0,234,255,.5); background:rgba(0,234,255,.25); color:#001018; font-weight:700;}
    .card .task .task-title{font-weight:600; display:block;}
    .card .task .task-title small{font-size:11px; font-weight:500; color:var(--muted); margin-left:6px; text-transform:uppercase; letter-spacing:.05em;}
    .card .task.is-done .task-title{text-decoration:line-through; color:var(--muted);}
    .card .task .task-meta{display:flex; flex-wrap:wrap; gap:6px; color:var(--muted); font-size:11px; margin-top:4px; text-transform:uppercase; letter-spacing:.06em;}
    .card .tasks.empty{margin:16px 0 0; padding:12px; border-radius:10px; border:1px dashed rgba(255,255,255,.12); color:var(--muted); text-align:center; font-size:12px; background:rgba(255,255,255,.02);}
    .ribbon{position:absolute; top:8px; right:-36px; transform:rotate(35deg); background:linear-gradient(90deg, var(--primary), var(--accent)); color:#001018;
      padding:4px 48px; font-size:12px; font-weight:800; letter-spacing:.08em; text-transform:uppercase; box-shadow:0 0 18px rgba(0,234,255,.45)}

    /* Responsive for vertical */
    @media (max-width:900px){
      .item{grid-template-columns:1fr;}
      .timeline::before{left:24px; transform:none}
      .node{left:14px}
      .card{margin-left:52px}
      .task-row{grid-template-columns:1fr; gap:8px}
      .task-row .done{justify-content:flex-start}
    }

    /* ---------- VUE 2 : Roadmap horizontale en swimlanes ---------- */
    .roadwrap{ width:min(1400px, 95%); margin:0 auto; }
    .roadscroll{ position:relative; overflow-x:auto; overflow-y:hidden; border:1px solid rgba(255,255,255,.08); border-radius:16px; backdrop-filter:blur(6px);
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,.08) 0 1px, transparent 1px calc(var(--month)), transparent calc(var(--month)) calc(2*var(--month))),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .roadmap{ position:relative; min-width:1200px; height:auto; padding-top:48px; }

    /* Axe des mois (sticky) */
    .axis{ position:sticky; top:0; z-index:2; height:36px; display:flex; align-items:center; gap:0; background:linear-gradient(180deg, rgba(5,6,13,.75), rgba(5,6,13,.35));
      border-bottom:1px solid rgba(255,255,255,.08); }
    .axis .tick{ position:relative; width:calc(var(--month)); text-align:center; font-size:12px; color:var(--muted); padding:6px 0; }
    .axis .tick::after{ content:""; position:absolute; right:0; top:0; bottom:0; width:1px; background:rgba(255,255,255,.08) }

    /* Lignes (swimlanes) */
    .lanes{ position:relative; }
    .lane{ position:relative; height:74px; border-bottom:1px dashed rgba(255,255,255,.08); }
    .lane.is-dim{ opacity:.35; filter:saturate(.6) }

    /* Libell√© de ligne (collant √† gauche dans la zone scroll) */
    .lane .label{ position:sticky; left:0; z-index:1; height:100%; display:flex; align-items:center; gap:10px; padding:0 12px; width:210px;
      background:linear-gradient(90deg, rgba(5,6,13,.85), rgba(5,6,13,.0)); border-right:1px solid rgba(255,255,255,.08);
      font-size:13px; text-transform:capitalize; color:var(--text); }
    .lane .label .dot{ width:10px; height:10px; border-radius:50%; box-shadow:0 0 10px currentColor }
    .lane[data-cat="developpement"] .label .dot{ color:#00eaff }
    .lane[data-cat="experience"] .label .dot{ color:#ff6ec7 }
    .lane[data-cat="alignement"] .label .dot{ color:#ffd166 }
    .lane[data-cat="operations"] .label .dot{ color:#5bd3ff }
    .lane[data-cat="lancement"] .label .dot{ color:#8a2be2 }

    /* Zone des events (bars) */
    .lane .bars{ position:relative; height:100%; margin-left:210px; }
    .taskMarkers{ position:absolute; inset:0; pointer-events:none; z-index:2; }
    .taskMarker{ position:absolute; top:6px; width:14px; height:14px; border-radius:50%; border:1px solid rgba(255,255,255,.35); background:linear-gradient(130deg, rgba(0,234,255,.55), rgba(138,43,226,.45)); box-shadow:0 0 12px rgba(0,234,255,.45); pointer-events:auto; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease, opacity .2s ease; display:grid; place-items:center; color:#02121a; font-size:10px; font-weight:700; z-index:3; }
    .taskMarker::before{content:'‚Ä¢'; line-height:1;}
    .taskMarker.is-done{background:linear-gradient(130deg, rgba(143,255,210,.85), rgba(0,234,255,.7)); border-color:rgba(143,255,210,.8); color:#012018; box-shadow:0 0 12px rgba(143,255,210,.55);}
    .taskMarker:focus-visible{outline:2px solid rgba(255,255,255,.8); outline-offset:2px; transform:scale(1.15);}
    .taskMarker:hover{transform:scale(1.1); box-shadow:0 0 16px rgba(0,234,255,.65);}
    .barItem{ position:absolute; top:16px; height:42px; min-width:32px; padding:8px 10px; border-radius:10px; display:flex; align-items:center; gap:8px;
      background:linear-gradient(120deg, rgba(0,234,255,.12), rgba(138,43,226,.12)); border:1px solid rgba(255,255,255,.18);
      box-shadow:0 8px 20px rgba(0,0,0,.25), 0 0 14px rgba(0,234,255,.15); backdrop-filter:blur(3px); white-space:nowrap; transform:translateZ(0);
      will-change:transform; }
    .barItem .ic{ font-size:14px }
    .barItem .t{ font-weight:700; font-size:13px }
    .barItem .d{ font-size:12px; color:var(--muted) }

    /* Ligne verticale "Aujourd'hui" */
    .todayLine{ position:absolute; top:36px; bottom:0; width:2px; background:linear-gradient(180deg, var(--primary), var(--accent)); box-shadow:0 0 14px rgba(0,234,255,.35); }

    /* Tooltip simple */
    .barItem[data-hint]:hover::after,
    .taskMarker[data-hint]:hover::after,
    .taskMarker[data-hint]:focus-visible::after{
      content:attr(data-hint); position:absolute; left:0; bottom:calc(100% + 8px); max-width:320px;
      background:rgba(0,8,14,.95); border:1px solid rgba(255,255,255,.15); padding:8px 10px; border-radius:8px; font-size:12px; color:var(--text);
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }

    /* Panneau de d√©tail */
    .overlay{position:fixed; inset:0; background:rgba(1,4,12,.75); backdrop-filter:blur(6px); display:none; z-index:9;}
    .overlay[data-open="true"]{display:block}
    .panel{position:fixed; right:0; top:0; bottom:0; width:min(480px, 92%); background:rgba(4,10,24,.96); border-left:1px solid rgba(0,234,255,.25);
      box-shadow:-20px 0 40px rgba(0,0,0,.45); transform:translateX(100%); transition:transform .3s ease; z-index:10; display:flex; flex-direction:column;}
    .panel[data-open="true"]{transform:translateX(0)}
    .panel header{display:flex; align-items:center; justify-content:space-between; padding:24px 24px 12px; border-bottom:1px solid rgba(255,255,255,.08);}
    .panel header h2{font-family:"Orbitron", sans-serif; font-size:18px; margin:0; letter-spacing:.08em; text-transform:uppercase; color:var(--text);}
    .panel header .close{all:unset; cursor:pointer; color:var(--muted); font-size:20px; padding:4px; border-radius:6px; transition:.2s ease;}
    .panel header .close:hover{color:var(--text); background:rgba(255,255,255,.08)}
    .panel form{flex:1; overflow-y:auto; padding:16px 24px 32px; display:flex; flex-direction:column; gap:16px;}
    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);}
    .field input, .field textarea, .field select{
      padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(0,12,24,.6); color:var(--text);
      font-size:14px; font-family:inherit;
    }
    .field textarea{min-height:90px; resize:vertical}
    .tasks-block{border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:16px; background:rgba(0,12,24,.4); display:flex; flex-direction:column; gap:12px;}
    .tasks-block h3{margin:0; font-size:14px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);}
    .task-row{display:grid; grid-template-columns:1fr 120px 120px auto 32px; gap:10px; align-items:center; padding:10px; border-radius:10px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06);}
    .task-row input[type="text"]{width:100%;}
    .task-row input[type="date"]{width:100%; font-size:13px;}
    .task-row .done{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);}
    .task-row .remove{all:unset; cursor:pointer; color:#ff6b6b; font-size:16px; padding:4px; border-radius:6px;}
    .task-row .remove:hover{background:rgba(255,107,107,.18)}
    .task-row input[type="checkbox"]{accent-color:var(--primary);}
    .tasks-block .add-task{align-self:flex-start; padding:8px 12px; border-radius:999px; border:1px dashed rgba(0,234,255,.4); background:rgba(0,234,255,.08); color:var(--text); font-size:12px; cursor:pointer;}
    .tasks-block .add-task:hover{border-style:solid}
    .tasks-block .empty{margin:0; font-size:13px; color:var(--muted); padding:12px; border-radius:10px; border:1px dashed rgba(255,255,255,.12); background:rgba(255,255,255,.02);}
    .panel footer{padding:16px 24px 24px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:12px;}
    .panel footer button{flex:1; padding:12px 16px; border-radius:12px; border:1px solid rgba(0,234,255,.4); background:linear-gradient(120deg, rgba(0,234,255,.18), rgba(138,43,226,.12)); color:var(--text); font-weight:600; letter-spacing:.05em; cursor:pointer; text-transform:uppercase; font-size:12px;}
    .panel footer .secondary{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.12); color:var(--muted);}
    .panel footer button:hover{filter:brightness(1.1)}

    /* Footer */
    footer{color:var(--muted); text-align:center; margin:60px 0 50px}
  </style>
</head>
<body class="view-roadmap">
  <div class="stars"></div>

  <header class="hero">
    <div class="brand">ECLIPTICA // Hub de pilotage</div>
    <h1>Objectifs SPHAIRA <span class="grad">2025</span></h1>
    <p class="lead">Visualisez, orchestrez et synchronisez la feuille de route de <strong>SPHAIRA</strong> avec <strong>ORIS</strong>. Les vues <strong>Verticale</strong> et <strong>Roadmap</strong> refl√®tent en temps r√©el les √©volutions partag√©es entre les plateformes.</p>

    <div class="controls" role="region" aria-label="Filtres et navigation">
      <button class="chip" data-cat="tous" data-active="true"><span class="dot"></span> Tous</button>
      <button class="chip" data-cat="developpement"><span class="dot"></span> D√©veloppement</button>
      <button class="chip" data-cat="experience"><span class="dot"></span> Exp√©rience</button>
      <button class="chip" data-cat="alignement"><span class="dot"></span> Alignement</button>
      <button class="chip" data-cat="operations"><span class="dot"></span> Op√©rations</button>
      <button class="chip" data-cat="lancement"><span class="dot"></span> Lancements</button>

      <span class="spacer"></span>

      <button class="action-btn" id="createObjective"><span class="ic">Ôºã</span> Nouvel objectif</button>

      <div class="months" aria-label="Aller au mois">
        <button data-go="01">Jan</button>
        <button data-go="02">F√©v</button>
        <button data-go="03">Mar</button>
        <button data-go="04">Avr</button>
        <button data-go="05">Mai</button>
        <button data-go="06">Juin</button>
        <button data-go="07">Juil</button>
        <button data-go="08">Ao√ªt</button>
        <button data-go="09">Sep</button>
        <button data-go="10">Oct</button>
        <button data-go="11">Nov</button>
        <button data-go="12">D√©c</button>
      </div>

      <div class="meter" title="Progression de l'ann√©e 2025">
        <span>Progression</span>
        <div class="bar"><i id="yearProgress"></i></div>
        <span id="yearPct">0%</span>
      </div>

      <div class="view" aria-label="Changer de vue">
        <button class="chip chip-view" data-view="vertical"><span class="dot"></span> Vue verticale</button>
        <button class="chip chip-view" data-view="roadmap" data-active="true"><span class="dot"></span> Vue roadmap</button>
      </div>
    </div>
    <div class="sync-status" id="syncStatus" role="status" aria-live="polite">
      <span class="pulse" aria-hidden="true"></span>
      <span>Synchronisation pr√™te avec SPHAIRA & ORIS.</span>
    </div>
  </header>

  <main class="wrap">
    <!-- Vue 1: verticale -->
    <section id="timelineVertical" class="timeline" aria-label="Timeline 2025 (vertical)"></section>

    <!-- Vue 2: roadmap horizontale -->
    <section id="roadmapHoriz" class="roadwrap" aria-label="Timeline 2025 (roadmap)">
      <div class="roadscroll" id="roadscroll">
        <div class="axis" id="axis"></div>
        <div class="roadmap" id="roadmap">
          <div class="lanes" id="lanes"></div>
          <!-- Ligne "Aujourd'hui" -->
          <div class="todayLine" id="todayLine" hidden></div>
        </div>
      </div>
    </section>
  </main>

  <div class="overlay" id="panelOverlay" aria-hidden="true"></div>
  <aside class="panel" id="detailPanel" data-open="false" aria-hidden="true">
    <header>
      <h2 id="panelHeading">Nouvel objectif</h2>
      <button type="button" class="close" id="closePanel" aria-label="Fermer la fen√™tre">√ó</button>
    </header>
    <form id="objectiveForm">
      <div class="field">
        <label for="objectiveTitle">Titre de l'objectif</label>
        <input id="objectiveTitle" name="title" required placeholder="Ex : Stabiliser le noyau SPHAIRA">
      </div>
      <div class="field">
        <label for="objectiveDate">√âch√©ance</label>
        <input id="objectiveDate" name="date" type="date" required>
      </div>
      <div class="field">
        <label for="objectiveCategory">Piliers</label>
        <select id="objectiveCategory" name="category" required>
          <option value="developpement">D√©veloppement</option>
          <option value="experience">Exp√©rience</option>
          <option value="alignement">Alignement</option>
          <option value="operations">Op√©rations</option>
          <option value="lancement">Lancements</option>
        </select>
      </div>
      <div class="field">
        <label for="objectiveLead">Pilote</label>
        <input id="objectiveLead" name="lead" placeholder="Nom du pilote">
      </div>
      <div class="field">
        <label for="objectiveIcon">Ic√¥ne</label>
        <input id="objectiveIcon" name="icon" maxlength="3" placeholder="üõ†Ô∏è">
      </div>
      <div class="field">
        <label for="objectiveDesc">Description</label>
        <textarea id="objectiveDesc" name="desc" placeholder="Synth√®se de l'impact et du livrable"></textarea>
      </div>
      <div class="tasks-block">
        <h3>T√¢ches li√©es</h3>
        <div id="tasksContainer" aria-live="polite"></div>
        <button type="button" class="add-task" id="addTaskBtn">Ôºã Ajouter une t√¢che</button>
      </div>
    </form>
    <footer>
      <button type="button" class="secondary" id="deleteObjective" hidden>Supprimer</button>
      <button type="submit" form="objectiveForm" id="saveObjective">Enregistrer & synchroniser</button>
    </footer>
  </aside>

  <footer>
    ECLIPTICA assure la coh√©rence des plans d'action : toute mise √† jour est envoy√©e instantan√©ment dans <strong>SPHAIRA</strong> et <strong>ORIS</strong> pour maintenir un pilotage unifi√©.
  </footer>

  <script src="shared/sphaira-data.js"></script>
  <script>
    const CATEGORY_META = {
      developpement: { label: 'D√©veloppement', description: 'Livraisons produit SPHAIRA' },
      experience: { label: 'Exp√©rience', description: 'Confort des responsables et √©quipes' },
      alignement: { label: 'Alignement', description: 'Synchronisation SPHAIRA ‚ÜîÔ∏é ORIS' },
      operations: { label: 'Op√©rations', description: 'Fiabilit√© et gouvernance' },
      lancement: { label: 'Lancements', description: 'Adoption & diffusion' }
    };
    const CATEGORY_ORDER = Object.keys(CATEGORY_META);

    const SPHAIRA_API_BASE_URL = window.SPHAIRA_API_BASE || 'memory://sphaira';
    const SPHAIRA_STORAGE_KEY = window.SPHAIRA_STORAGE_KEY || 'sphaira:objectives';

    let OBJECTIVES = [];
    let objectivesLoadingPromise = null;

    const start = new Date('2025-01-01T00:00:00');
    const end   = new Date('2025-12-31T23:59:59');
    const isYear2025 = new Date().getFullYear() === 2025;

    let currentFilter = 'tous';
    let currentObjectiveId = null;

    const overlay = document.getElementById('panelOverlay');
    const panel = document.getElementById('detailPanel');
    const panelHeading = document.getElementById('panelHeading');
    const closePanelBtn = document.getElementById('closePanel');
    const objectiveForm = document.getElementById('objectiveForm');
    const tasksContainer = document.getElementById('tasksContainer');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const deleteObjectiveBtn = document.getElementById('deleteObjective');
    const createObjectiveBtn = document.getElementById('createObjective');
    const syncStatus = document.getElementById('syncStatus');
    const syncStatusMessage = syncStatus.querySelector('span:last-child');

    function uid(prefix){
      return `${prefix}-${Math.random().toString(36).slice(2,8)}${Date.now().toString(36).slice(-2)}`;
    }

    function normalizeObjective(obj){
      if(!obj || typeof obj !== 'object') return null;
      const tasks = Array.isArray(obj.tasks) ? obj.tasks.map(task => {
        if(!task || typeof task !== 'object') return null;
        return {
          id: task.id || uid('task'),
          title: String(task.title ?? '').trim(),
          owner: String(task.owner ?? '').trim(),
          due: task.due ? String(task.due) : '',
          done: Boolean(task.done)
        };
      }).filter(Boolean) : [];
      return {
        id: obj.id || uid('obj'),
        date: obj.date ? String(obj.date) : new Date().toISOString().slice(0,10),
        title: String(obj.title ?? '').trim() || 'Objectif sans titre',
        cat: String(obj.cat ?? 'developpement'),
        icon: obj.icon ? String(obj.icon) : 'üóÇÔ∏è',
        lead: obj.lead ? String(obj.lead) : '',
        desc: obj.desc ? String(obj.desc) : '',
        tasks
      };
    }

    async function loadObjectivesFromSphaira(){
      if(objectivesLoadingPromise){
        return objectivesLoadingPromise;
      }

      syncStatusMessage.textContent = 'Chargement depuis SPHAIRA‚Ä¶';
      objectivesLoadingPromise = (async () => {
        try {
          const response = await fetch(`${SPHAIRA_API_BASE_URL}/objectives`);
          let payload;
          if(response.ok){
            payload = await response.json();
          } else {
            let message = response.statusText || `Code ${response.status}`;
            try {
              const errorPayload = await response.json();
              if(errorPayload && errorPayload.error){
                message = errorPayload.error;
              }
            } catch(_){}
            throw new Error(message);
          }

          const normalized = Array.isArray(payload) ? payload.map(normalizeObjective).filter(Boolean) : [];
          normalized.sort((a, b) => new Date(a.date) - new Date(b.date));
          OBJECTIVES = normalized;
          refreshTimelines();
          const ts = new Date().toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
          syncStatusMessage.textContent = `Synchronis√© avec SPHAIRA ‚Äî ${ts}`;
        } catch(error){
          console.error('Erreur lors du chargement des objectifs SPHAIRA', error);
          syncStatusMessage.textContent = `Erreur de synchronisation SPHAIRA : ${error.message}`;
        } finally {
          objectivesLoadingPromise = null;
        }
      })();

      return objectivesLoadingPromise;
    }

    async function persistObjectiveToSphaira(objective, isUpdate){
      const url = isUpdate
        ? `${SPHAIRA_API_BASE_URL}/objectives/${encodeURIComponent(objective.id)}`
        : `${SPHAIRA_API_BASE_URL}/objectives`;
      const response = await fetch(url, {
        method: isUpdate ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(objective)
      });
      if(!response.ok){
        let message = response.statusText || `Code ${response.status}`;
        try {
          const errorPayload = await response.json();
          if(errorPayload && errorPayload.error){
            message = errorPayload.error;
          }
        } catch(_){}
        throw new Error(message);
      }
      return response.json();
    }

    async function deleteObjectiveFromSphaira(id){
      const response = await fetch(`${SPHAIRA_API_BASE_URL}/objectives/${encodeURIComponent(id)}`, { method: 'DELETE' });
      if(!response.ok){
        let message = response.statusText || `Code ${response.status}`;
        try {
          const errorPayload = await response.json();
          if(errorPayload && errorPayload.error){
            message = errorPayload.error;
          }
        } catch(_){}
        throw new Error(message);
      }
    }

    function fmtDate(d, withYear = false){
      const opts = { day:'2-digit', month:'short' };
      if(withYear) opts.year = 'numeric';
      return new Intl.DateTimeFormat('fr-FR', opts).format(d).replace('.', '');
    }

    function getCategoryLabel(cat){
      return CATEGORY_META[cat]?.label ?? cat;
    }

    function pctOfYear(d){
      return ((d - start) / (end - start)) * 100;
    }

    function clamp(value, min, max){
      return Math.min(max, Math.max(min, value));
    }

    function groupByMonth(items){
      const map = new Map(Array.from({length:12}, (_,i)=>[(i+1).toString().padStart(2,'0'), []]));
      for(const obj of items){
        const d = new Date(obj.date);
        const key = (d.getMonth()+1).toString().padStart(2,'0');
        const enriched = {...obj, d};
        map.get(key)?.push(enriched);
      }
      for(const [, arr] of map){
        arr.sort((a,b)=>a.d-b.d);
      }
      return map;
    }

    function groupByCat(items){
      const map = new Map(CATEGORY_ORDER.map(cat => [cat, []]));
      for(const obj of items){
        const d = new Date(obj.date);
        if(map.has(obj.cat)){
          map.get(obj.cat).push({...obj, d});
        }
      }
      for(const [, arr] of map){
        arr.sort((a,b)=>a.d-b.d);
      }
      return map;
    }

    function computeTaskSummary(obj){
      const total = obj.tasks?.length ?? 0;
      const done = obj.tasks?.filter(t => t.done).length ?? 0;
      const pct = total === 0 ? 0 : Math.round((done / total) * 100);
      return { total, done, pct };
    }

    function buildTaskList(tasks){
      if(!tasks || tasks.length === 0){
        const empty = document.createElement('div');
        empty.className = 'tasks empty';
        empty.textContent = 'Aucune t√¢che renseign√©e';
        return empty;
      }

      const list = document.createElement('ul');
      list.className = 'tasks';
      list.setAttribute('role', 'list');

      tasks.forEach(task => {
        const item = document.createElement('li');
        item.className = 'task' + (task.done ? ' is-done' : '');

        const check = document.createElement('span');
        check.className = 'check';
        check.textContent = task.done ? '‚úì' : '';
        check.setAttribute('aria-hidden', 'true');
        item.appendChild(check);

        const details = document.createElement('div');

        const title = document.createElement('span');
        title.className = 'task-title';
        title.textContent = task.title;
        const rawDue = task.due ? new Date(task.due) : null;
        const hasValidDue = rawDue && !Number.isNaN(rawDue.valueOf());
        const badge = document.createElement('small');
        badge.textContent = hasValidDue ? fmtDate(rawDue, true) : 'Sans √©ch√©ance';
        title.appendChild(badge);
        details.appendChild(title);

        const metaBits = [];
        if(task.owner){
          metaBits.push(`üë§ ${task.owner}`);
        }
        metaBits.push(task.done ? '‚úì Termin√©' : '‚Ä¢ √Ä suivre');
        if(metaBits.length){
          const meta = document.createElement('span');
          meta.className = 'task-meta';
          meta.textContent = metaBits.join(' ‚Ä¢ ');
          details.appendChild(meta);
        }

        item.appendChild(details);
        list.appendChild(item);
      });

      return list;
    }

    function renderVertical(){
      const container = document.getElementById('timelineVertical');
      const byMonth = groupByMonth(OBJECTIVES);
      const today = new Date();
      const todayKey = isYear2025 ? (today.getMonth()+1).toString().padStart(2,'0') : null;

      container.innerHTML = '';
      for(let i=1;i<=12;i++){
        const key = i.toString().padStart(2,'0');
        const section = document.createElement('section');
        section.className = 'month' + (todayKey === key ? ' is-today' : '');
        section.id = `m${key}`;

        const heading = document.createElement('h2');
        heading.textContent = new Date(`2025-${key}-01`).toLocaleDateString('fr-FR', {month:'long'});
        section.appendChild(heading);

        const monthObjectives = byMonth.get(key) ?? [];
        if(monthObjectives.length === 0){
          const empty = document.createElement('div');
          empty.className = 'item is-empty';
          empty.dataset.placeholder = 'true';
          empty.innerHTML = `<span class="node" aria-hidden="true"></span><div class="card"><div class="meta">Aucun objectif planifi√©</div></div>`;
          section.appendChild(empty);
        } else {
          monthObjectives.forEach(obj => {
            const summary = computeTaskSummary(obj);
            const progressText = summary.total ? `${summary.done}/${summary.total} t√¢ches` : 'Aucune t√¢che';
            const item = document.createElement('article');
            item.className = 'item';
            item.dataset.cat = obj.cat;
            item.dataset.id = obj.id;

            const isTodayObjective = isYear2025 && obj.d.toDateString() === today.toDateString();
            item.innerHTML = `
              <span class="node" aria-hidden="true"></span>
              <div class="card" role="button" tabindex="0" aria-label="${obj.title}">
                ${isTodayObjective ? '<div class="ribbon">Aujourd\'hui</div>' : ''}
                <div class="top">
                  <div class="icon">${obj.icon || 'üóÇÔ∏è'}</div>
                  <div>
                    <div class="title">${obj.title}</div>
                    <div class="meta">
                      <span>${fmtDate(obj.d)}</span>
                      <span class="badge" data-cat="${obj.cat}">${getCategoryLabel(obj.cat)}</span>
                      <span>${progressText}</span>
                    </div>
                  </div>
                </div>
                <div class="meta">
                  ${obj.lead ? `<span>üë§ ${obj.lead}</span>` : ''}
                  <span>Synchronis√© SPHAIRA ‚Ä¢ ORIS</span>
                </div>
                <p class="desc">${obj.desc || ''}</p>
              </div>
            `;
            section.appendChild(item);

            const card = item.querySelector('.card');
            card.appendChild(buildTaskList(obj.tasks));
            card.addEventListener('click', () => openPanel(obj.id));
            card.addEventListener('keydown', (ev) => {
              if(ev.key === 'Enter' || ev.key === ' '){
                ev.preventDefault();
                openPanel(obj.id);
              }
            });
          });
        }

        container.appendChild(section);
      }
    }

    function renderRoadmap(){
      const axis = document.getElementById('axis');
      const lanesWrap = document.getElementById('lanes');
      const todayLine = document.getElementById('todayLine');

      axis.innerHTML = '';
      for(let i=0;i<12;i++){
        const tick = document.createElement('div');
        tick.className = 'tick';
        tick.style.width = 'calc(var(--month))';
        tick.textContent = new Date(2025, i, 1).toLocaleDateString('fr-FR', {month:'short'}).replace('.', '');
        axis.appendChild(tick);
      }

      lanesWrap.innerHTML = '';
      const byCat = groupByCat(OBJECTIVES);
      for(const [cat, arr] of byCat){
        if(arr.length === 0) continue;
        const lane = document.createElement('div');
        lane.className = 'lane';
        lane.dataset.cat = cat;

        const label = document.createElement('div');
        label.className = 'label';
        label.innerHTML = `<span class="dot"></span> ${getCategoryLabel(cat)}`;
        lane.appendChild(label);

        const bars = document.createElement('div');
        bars.className = 'bars';
        const markers = document.createElement('div');
        markers.className = 'taskMarkers';
        bars.appendChild(markers);

        arr.forEach(obj => {
          const left = pctOfYear(obj.d);
          const bar = document.createElement('div');
          bar.className = 'barItem';
          bar.dataset.cat = obj.cat;
          bar.dataset.id = obj.id;
          bar.style.left = `calc(${left}% - 80px)`;
          bar.style.width = 'max(2%, 140px)';
          const summary = computeTaskSummary(obj);
          const progressText = summary.total ? `${summary.done}/${summary.total} t√¢ches` : 'Aucune t√¢che';
          bar.setAttribute('data-hint', `${fmtDate(obj.d, true)} ‚Äî ${progressText}`);
          bar.innerHTML = `<span class="ic">${obj.icon || 'üóÇÔ∏è'}</span><span class="t">${obj.title}</span><span class="d">‚Ä¢ ${fmtDate(obj.d)}</span>`;
          bar.setAttribute('role', 'button');
          bar.setAttribute('tabindex', '0');
          bars.appendChild(bar);

          if(Array.isArray(obj.tasks)){
            obj.tasks.forEach(task => {
              const rawDue = task.due ? new Date(task.due) : null;
              const hasValidDue = rawDue && !Number.isNaN(rawDue.valueOf());
              const dueDate = hasValidDue ? rawDue : obj.d;
              if(!dueDate || Number.isNaN(dueDate.valueOf())){
                return;
              }
              const marker = document.createElement('span');
              marker.className = 'taskMarker' + (task.done ? ' is-done' : '');
              marker.dataset.cat = obj.cat;
              marker.dataset.taskId = task.id || '';
              marker.dataset.objectiveId = obj.id;
              const pct = clamp(pctOfYear(dueDate), 0, 100);
              marker.style.left = `calc(${pct}% - 7px)`;
              const statusLabel = task.done ? 'Termin√©' : '√Ä suivre';
              const ownerLabel = task.owner ? ` ‚Ä¢ ${task.owner}` : '';
              marker.setAttribute('data-hint', `${task.title} ‚Äî ${statusLabel}${ownerLabel} ‚Ä¢ ${fmtDate(dueDate, true)}`);
              marker.setAttribute('role', 'button');
              marker.setAttribute('tabindex', '0');
              marker.addEventListener('click', () => openPanel(obj.id));
              marker.addEventListener('keydown', (ev) => {
                if(ev.key === 'Enter' || ev.key === ' '){
                  ev.preventDefault();
                  openPanel(obj.id);
                }
              });
              markers.appendChild(marker);
            });
          }

          bar.addEventListener('click', () => openPanel(obj.id));
          bar.addEventListener('keydown', (ev) => {
            if(ev.key === 'Enter' || ev.key === ' '){
              ev.preventDefault();
              openPanel(obj.id);
            }
          });
        });

        lane.appendChild(bars);
        lanesWrap.appendChild(lane);
      }

      if(isYear2025){
        const position = pctOfYear(new Date());
        todayLine.style.left = `calc(${position}% + 210px)`;
        todayLine.hidden = false;
      } else {
        todayLine.hidden = true;
      }
    }

    function applyFilter(cat){
      currentFilter = cat;
      document.querySelectorAll('#timelineVertical .item').forEach(item => {
        if(item.dataset.placeholder === 'true'){
          item.style.display = cat === 'tous' ? '' : 'none';
          return;
        }
        if(cat === 'tous'){
          item.style.display = '';
        } else {
          item.style.display = item.dataset.cat === cat ? '' : 'none';
        }
      });

      document.querySelectorAll('#timelineVertical .month').forEach(section => {
        const hasVisible = Array.from(section.querySelectorAll('.item')).some(it => it.style.display !== 'none');
        section.style.display = hasVisible ? '' : 'none';
      });

      document.querySelectorAll('#lanes .lane').forEach(lane => {
        if(cat === 'tous'){
          lane.style.display = '';
          lane.classList.remove('is-dim');
          lane.querySelectorAll('.barItem').forEach(bar => {
            bar.style.opacity = 1;
            bar.style.pointerEvents = 'auto';
          });
          lane.querySelectorAll('.taskMarker').forEach(marker => {
            marker.style.opacity = 1;
            marker.style.pointerEvents = 'auto';
            marker.setAttribute('tabindex', '0');
          });
        } else {
          const match = lane.dataset.cat === cat;
          lane.style.display = '';
          lane.classList.toggle('is-dim', !match);
          lane.querySelectorAll('.barItem').forEach(bar => {
            bar.style.opacity = match ? 1 : 0.2;
            bar.style.pointerEvents = match ? 'auto' : 'none';
          });
          lane.querySelectorAll('.taskMarker').forEach(marker => {
            marker.style.opacity = match ? 1 : 0.2;
            marker.style.pointerEvents = match ? 'auto' : 'none';
            marker.setAttribute('tabindex', match ? '0' : '-1');
          });
        }
      });
    }

    function attachMonthNav(){
      document.querySelectorAll('.months button').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.go;
          if(document.body.classList.contains('view-vertical')){
            document.getElementById(`m${key}`)?.scrollIntoView({behavior:'smooth', block:'start'});
          } else {
            const scroll = document.getElementById('roadscroll');
            const ratio = (parseInt(key, 10) - 1) / 12;
            const target = ratio * (scroll.scrollWidth - scroll.clientWidth);
            scroll.scrollTo({ left: Math.max(0, target), behavior: 'smooth' });
          }
        });
      });
    }

    function setYearProgress(){
      const now = new Date();
      let pct = 0;
      if(now < start) pct = 0;
      else if(now > end) pct = 100;
      else pct = ((now - start) / (end - start)) * 100;
      document.getElementById('yearProgress').style.setProperty('--p', pct.toFixed(2) + '%');
      document.getElementById('yearPct').textContent = Math.round(pct) + '%';
    }

    function attachViewSwitch(){
      const chips = document.querySelectorAll('.chip-view');
      chips.forEach(chip => {
        chip.addEventListener('click', () => {
          chips.forEach(c => c.dataset.active = 'false');
          chip.dataset.active = 'true';
          const view = chip.dataset.view;
          document.body.classList.toggle('view-vertical', view === 'vertical');
          document.body.classList.toggle('view-roadmap', view === 'roadmap');
        });
      });
    }

    function attachFilters(){
      const chips = [...document.querySelectorAll('.controls > .chip[data-cat]')];
      chips.forEach(chip => {
        chip.addEventListener('click', () => {
          chips.forEach(c => c.dataset.active = 'false');
          chip.dataset.active = 'true';
          applyFilter(chip.dataset.cat);
        });
      });
    }

    function showEmptyTaskMessage(){
      tasksContainer.innerHTML = '<p class="empty">Aucune t√¢che d√©finie pour le moment.</p>';
    }

    function buildTaskRow(task = {}){
      const row = document.createElement('div');
      row.className = 'task-row';
      const rowId = task.id || uid('task');
      row.dataset.id = rowId;
      row.innerHTML = `
        <input type="text" class="task-title" placeholder="Titre de la t√¢che" value="${task.title ?? ''}" required>
        <input type="text" class="task-owner" placeholder="Pilote" value="${task.owner ?? ''}">
        <input type="date" class="task-due" value="${task.due ?? ''}">
        <label class="done"><input type="checkbox" class="task-done" ${task.done ? 'checked' : ''}> Termin√©</label>
        <button type="button" class="remove" title="Supprimer la t√¢che">√ó</button>
      `;
      row.querySelector('.remove').addEventListener('click', () => {
        row.remove();
        ensureTaskEmptyState();
      });
      return row;
    }

    function ensureTaskEmptyState(){
      if(!tasksContainer.querySelector('.task-row')){
        showEmptyTaskMessage();
      }
    }

    function renderTaskRows(tasks){
      tasksContainer.innerHTML = '';
      if(!tasks || tasks.length === 0){
        showEmptyTaskMessage();
        return;
      }
      tasks.forEach(task => {
        tasksContainer.appendChild(buildTaskRow(task));
      });
    }

    function addTaskRow(task = {}){
      if(tasksContainer.querySelector('.empty')){
        tasksContainer.innerHTML = '';
      }
      tasksContainer.appendChild(buildTaskRow(task));
    }

    function openPanel(id = null){
      currentObjectiveId = id;
      overlay.dataset.open = 'true';
      overlay.setAttribute('aria-hidden', 'false');
      panel.dataset.open = 'true';
      panel.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      objectiveForm.reset();

      if(id){
        const obj = OBJECTIVES.find(item => item.id === id);
        if(!obj){
          showEmptyTaskMessage();
          return;
        }
        panelHeading.textContent = obj.title;
        document.getElementById('objectiveTitle').value = obj.title;
        document.getElementById('objectiveDate').value = obj.date;
        document.getElementById('objectiveCategory').value = obj.cat;
        document.getElementById('objectiveLead').value = obj.lead || '';
        document.getElementById('objectiveIcon').value = obj.icon || '';
        document.getElementById('objectiveDesc').value = obj.desc || '';
        renderTaskRows(obj.tasks || []);
        deleteObjectiveBtn.hidden = false;
      } else {
        panelHeading.textContent = 'Nouvel objectif';
        const today = new Date();
        const defaultDate = today.getFullYear() === 2025 ? today.toISOString().slice(0,10) : '2025-01-01';
        document.getElementById('objectiveDate').value = defaultDate;
        document.getElementById('objectiveIcon').value = 'üóÇÔ∏è';
        renderTaskRows([]);
        deleteObjectiveBtn.hidden = true;
      }
    }

    function closePanel(){
      panel.dataset.open = 'false';
      panel.setAttribute('aria-hidden', 'true');
      overlay.dataset.open = 'false';
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      objectiveForm.reset();
      showEmptyTaskMessage();
      currentObjectiveId = null;
    }

    function syncWithSystems(action, objective){
      const ts = new Date().toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
      let message = '';
      if(action === 'cr√©ation'){
        message = `Cr√©ation synchronis√©e pour ¬´ ${objective.title} ¬ª ‚Äî SPHAIRA & ORIS mis √† jour (${ts}).`;
      } else if(action === 'suppression'){
        message = `Suppression synchronis√©e pour ¬´ ${objective.title} ¬ª (${ts}).`;
      } else {
        message = `Mise √† jour synchronis√©e pour ¬´ ${objective.title} ¬ª ‚Äî SPHAIRA & ORIS align√©s (${ts}).`;
      }
      syncStatusMessage.textContent = message;
    }

    function refreshTimelines(){
      renderVertical();
      renderRoadmap();
      applyFilter(currentFilter);
    }

    objectiveForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(objectiveForm);
      const baseId = currentObjectiveId ?? uid('obj');

      const tasks = Array.from(tasksContainer.querySelectorAll('.task-row')).map(row => {
        const title = row.querySelector('.task-title').value.trim();
        if(!title){
          return null;
        }
        return {
          id: row.dataset.id || uid('task'),
          title,
          owner: row.querySelector('.task-owner').value.trim(),
          due: row.querySelector('.task-due').value,
          done: row.querySelector('.task-done').checked
        };
      }).filter(Boolean);

      const objective = {
        id: baseId,
        date: formData.get('date'),
        title: formData.get('title').trim(),
        cat: formData.get('category'),
        lead: formData.get('lead').trim(),
        icon: (formData.get('icon') || 'üóÇÔ∏è').trim() || 'üóÇÔ∏è',
        desc: formData.get('desc').trim(),
        tasks
      };

      const existingIndex = OBJECTIVES.findIndex(obj => obj.id === baseId);
      const action = existingIndex > -1 ? 'mise √† jour' : 'cr√©ation';
      try {
        await persistObjectiveToSphaira(objective, existingIndex > -1);
        syncWithSystems(action, objective);
        closePanel();
        await loadObjectivesFromSphaira();
      } catch(error){
        console.error('Impossible de synchroniser l\'objectif avec SPHAIRA', error);
        syncStatusMessage.textContent = `Erreur de synchronisation SPHAIRA : ${error.message}`;
      }
    });

    deleteObjectiveBtn.addEventListener('click', async () => {
      if(!currentObjectiveId) return;
      const target = OBJECTIVES.find(obj => obj.id === currentObjectiveId);
      if(!target) return;
      const confirmation = window.confirm(`Supprimer l'objectif ¬´ ${target.title} ¬ª ?`);
      if(!confirmation) return;
      try {
        await deleteObjectiveFromSphaira(currentObjectiveId);
        syncWithSystems('suppression', target);
        closePanel();
        await loadObjectivesFromSphaira();
      } catch(error){
        console.error('Impossible de supprimer l\'objectif dans SPHAIRA', error);
        syncStatusMessage.textContent = `Erreur de synchronisation SPHAIRA : ${error.message}`;
      }
    });

    addTaskBtn.addEventListener('click', () => addTaskRow({}));
    createObjectiveBtn.addEventListener('click', () => openPanel());
    closePanelBtn.addEventListener('click', closePanel);
    overlay.addEventListener('click', closePanel);
    document.addEventListener('keydown', (event) => {
      if(event.key === 'Escape' && panel.dataset.open === 'true'){
        closePanel();
      }
    });

    window.addEventListener('sphaira:objectives', () => {
      loadObjectivesFromSphaira();
    });

    window.addEventListener('storage', (event) => {
      if(event.key === SPHAIRA_STORAGE_KEY){
        loadObjectivesFromSphaira();
      }
    });

    loadObjectivesFromSphaira();
    attachFilters();
    attachMonthNav();
    attachViewSwitch();
    setYearProgress();
    setInterval(setYearProgress, 60*60*1000);
  </script>
</body>
</html>
